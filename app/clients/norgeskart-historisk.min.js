"use strict";

var NK = NK || {};
NK.mapEventListeners = {};

var gkopen, 
    gkopen_wmts,
    proj,
    mapProj,
    mapBounds,
    xdmsocket,
    initLayers,
    postEvent,
    map;

gkopen = "http://opencache.statkart.no/gatekeeper/gk/gk.open";
gkopen_wmts = "http://opencache.statkart.no/gatekeeper/gk/gk.open_wmts";

NK.gkToken = "unInitialized";

NK.tokenService = "http://norgeskart.no/ws/gkt.py";

NK.baseProjection = "25833";
NK.baseProjection = "25833";

NK.tokenLastUpdated = new Date(0);
NK.tokenUpdatePaused = false;


NK.tokenError = {
  PAUSE_MINUTES: 2,
  RELOAD_LIMIT_SECONDS: 15,
  messagePopup: null,
  pauseTimeRemainingElement: null,
  pauseTimeRemainingText: null,
  pauseTimer: null,
  pauseCountdownTimer: null
};

NK.mapservers = {};
NK.mapservers.wmts = [
  "http://cache1.kartverket.no/grunnkart/wmts",
  "http://cache2.kartverket.no/grunnkart/wmts",
  "http://cache3.kartverket.no/grunnkart/wmts",
  "http://cache4.kartverket.no/grunnkart/wmts"
];
NK.zoomLevels = 18;

NK.functions = NK.functions || {};

NK.util = NK.util || {};

NK.util.getLayersBy = function(key, value) {
  return $.grep(map.getLayers().getArray(), function(l) {
    return l.get(key) == value;
  })
};

NK.util.getControlsByClass = function(cla) {
  return $.grep(map.getControls().getArray(), function(c) {
    return c instanceof cla;
  });
};

NK.util.getInteractionsByClass = function(cla) {
  return $.grep(map.getInteractions().getArray(), function(c) {
    return c instanceof cla;
  });
};

NK.util.createWidget = function( content, wCount, arrow ) {
    var widget = document.createElement('div'); 
    $(widget).addClass('widget');
    
    var wrapper = widget, count = ! wCount || isNaN(wCount) ? 0 : wCount;

    while (count-- > 0) {
		var w = document.createElement('div');    
		$(w).addClass('wrapper');
		wrapper.appendChild(w);
		wrapper = w;
    }
    
    var cnt = content || document.createElement('div');    

    if (!content) {
    	$(cnt).addClass('widgetCnt');    
    }

    wrapper.appendChild(cnt); 

    if (arrow) {
		var arrow1 = document.createElement('div');
		$(arrow1).addClass('arrow');

		var arrow2 = document.createElement('div');
		$(arrow2).addClass('arrow');
		arrow1.appendChild(arrow2); 
		
		wrapper.appendChild(arrow1);
    }
    return widget;
};

NK.supportedCRS = ['EPSG:32633','EPSG:25833','urn:ogc:def:crs:EPSG::32633','urn:ogc:def:crs:EPSG::25833'];
NK.supportedWFSFormats = ['application/json; subtype=geojson','application/json','text/xml; subtype=gml/3.1.1', 'text/xml; subtype=gml/3.2.1'];

NK.functions.getWMSCapabilities = function (url) {
  return NK.functions.corsRequest(url, {"service":"WMS", "request":"GetCapabilities"});
};
NK.functions.getWFSCapabilities = function (url) {
  return NK.functions.corsRequest(url, {"service":"WFS", "request":"GetCapabilities", "version":"1.1.0"});
};
NK.functions.getWCSCapabilities = function (url) {
  return NK.functions.corsRequest(url, {"service":"WCS", "request":"GetCapabilities"});
};
NK.functions.corsRequest = function (url, params) {
  if(!!url) {
    if (url.slice(-1) != '?') {url = url+'?';}
    for (var k in params) {
      url += k+"="+params[k]+"&";
    }
    return $.ajax({
      url: '/ws/px.py',
      //url: url,
      type: 'GET',
      data: url,
      dataType: 'xml'
    });
  }
};

NK.functions.addWMSLayer = function(wmsUrl) {
  if (NK.util.getLayersBy("url",wmsUrl).length) {return;}
  var layers = [], formats=[], crs=[], fiFormats=[], serviceParms={}, layerParms;

  var resultWMS = NK.functions.getWMSCapabilities(wmsUrl);
  resultWMS.error(function (msg) { NK.functions.log(msg.responseText); });
  resultWMS.done(function (xml) {
    serviceParms['version'] = $(xml).children()[0].getAttribute("version");
    $(xml).find('Service').each(function () {
      serviceParms['serviceTitle'] = $(this).children('Title').text();
    });
    $(xml).find('GetFeatureInfo').each(function () {
      $(this).children('Format').each(function() {
        fiFormats.push($(this).text());
      });
    });
    serviceParms['featureInfoFormats'] = fiFormats;
    $(xml).find('GetMap').each(function () {
      $(this).children('Format').each(function () {;
        formats.push($(this).text());
      });
    });
    serviceParms['formats'] = formats;
    var attribution;
    $(xml).find('Attribution').each(function () {
      var href = $(this).children('OnlineResource')[0];
      var logo = $(this).children('LogoURL').children('OnlineResource')[0];
      attribution = { 
          'title': $(this).children('Title').text(),
          'href' : href && href.getAttribute("xlink:href"),
          'logo' : logo && logo.getAttribute("xlink:href")
      }
    });
    if (!attribution) { attribution={'title':'missing', 'href':'#'}; }
    serviceParms['attribution'] = attribution;
    $(xml).find('AccessConstraints').each(function () {
      serviceParms['constraints'] = $(this).text();
    });
    $(xml).find('CRS').each(function () {
      crs.push($(this).text());
    });
    serviceParms['crs'] = crs;
    $(xml).find('Layer').each(function () {
      layerParms={};
      var name = $(this).children('Name').text();
      if (!name) {return;}

      /* if this layer is a child layer, identify parent */
      if ($(this).parent()[0].nodeName=="Layer") {
        layerParms['parent'] = $(this).parent().children('Title').text() || $(this).parent().children('Name').text();
      }

      layerParms['title'] = $(this).children('Title').text();
      layerParms['visible'] = !!NK.visibleLayerQueue[name];
      layerParms['opacity'] = NK.opacityQueue[name] || 1.0;
      if (name in NK.opacityQueue) {delete NK.opacityQueue[name];}
      if (name in NK.visibleLayerQueue) {delete NK.visibleLayerQueue[name];}
      layers.push(name);
      var bbox = $(xml).find('BoundingBox');
      if (!!bbox) {
        var atts = bbox[0].attributes;
        var srs = atts['CRS'] || atts['SRS'];
        if (srs && (srs.value == map.getView().getProjection().getCode())) { 
          layerParms['layerBounds'] = [atts["minx"].value, atts["miny"].value, atts["maxx"].value, atts["maxy"].value];
        }
      }
      layerParms['layerText']=name;
      NK.functions.createDynamicWMSLayer(layerParms['title'], wmsUrl, $.extend({},serviceParms,layerParms));
      if (!!NK.xdm) {
        NK.functions.postMessage({"type":"layerLoaded", "title":layerParms['title'], "parent":layerParms['parent'],"url":wmsUrl}); 
      }
    });
    NK.functions.updateHistory();
  });

  if (NK.controls.Geoportal) {
    var geoportal =  NK.util.getControlsByClass(NK.controls.Geoportal)[0]; // heh, the optimism!
    geoportal.showControls(wmsUrl);
    geoportal.displayLayerList();
  }
};

NK.functions.createDynamicWMSLayer = function (name, url, parms) {
  var crs = $.grep(parms['crs'], function(s) {
    return ($.inArray(s, NK.supportedCRS)>-1)
  })[0];

  var wms = new ol.layer.Image({
    title: parms['title'],
    source: new ol.source.ImageWMS({ 
      url: url,
      projection: crs,
      params: {
        LAYERS: parms['layerText'],
        VERSION: parms['version'], 
        //gkt: NK.gkToken || '',
        TRANSPARENT: true,
        EXCEPTIONS: 'XML',
        FORMAT: 'image/png'
      }
    }),
    serviceTitle: parms['serviceTitle'],
    parent: parms['parent'] || null,
    isBaseLayer: false,
    visible: parms['visible'],
    opacity: parms['opacity'] || 1.0,
    isUrlDataLayer: true,
    dataFormats: parms['formats'],
    attribution: parms['attribution'],
    constraints: parms['constraints'],
    type: 'wms'
  });
  if (!!parms['bounds']) {
    wms.set('maxExtent',parms['bounds']);
  }
  if (!!parms['featureInfoFormats']) {
    var formats = parms['featureInfoFormats'];
    var preferredFormats = ['application/vnd.ogc.wms_xml', 'text/xml', 'text/plain', 'text/html'];
    var preferredFormat  = 'x';

    while (preferredFormat && formats.indexOf(preferredFormat)==-1) {
      preferredFormat = preferredFormats.shift();
    }

    /* TODO *********
    if (!!preferredFormat) {
      var popupFn = NK.functions.popup.wmsFeatureInfoPopup;
      var featureInfo = new OpenLayers.Control.WMSGetFeatureInfo({
        url: url,
        proxyUrl: "/ws/px.py?"+url,
        title: parms['title'],
        queryVisible: true,
        infoFormat: preferredFormat,
        eventListeners: {
          "getfeatureinfo": function(event) {
            var popup = new OpenLayers.Popup.FramedSideAnchored(null, map.getLonLatFromPixel(event.xy), null, popupFn(event, formats), null, true,
                              NK.functions.closePopupCallBack, {x: 10, y: -65}, 'selected-feature-popup, user-marker')
            map.addPopup(popup, true);
            if (!event.features.length && (!event.text || !event.text.trim().length)) {
              setTimeout(function() {
                map.removePopup(popup);
              }, 3000);
            }
          }
        }
      });
      wms.featureInfoControl = featureInfo;
      wms.events.register('visibilitychanged', wms, function() {
        if(this.getVisibility()) {
          featureInfo.activate();
          if (!!this.maxExtent) {
            var extent = this.maxExtent;
            if (!extent.containsLonLat(map.getCenter())) {
              map.zoomToExtent(extent);
            }
          }
        } else {
          featureInfo.deactivate();
        }
      });
      map.addControl(featureInfo);
      if (parms['visible']) {
        featureInfo.activate();
      }
    }
    *********************/
  }
  map.addLayer(wms);
  // NK.functions.createLegend();
};

NK.functions.addWFSLayer = function(wfsUrl) {
  if (NK.util.getLayersBy("url",wfsUrl).length) {return;}
  var layers = [], crs=[], formats={}, serviceParms={}, layerParms;
  var resultWFS = NK.functions.getWFSCapabilities(wfsUrl);
  resultWFS.error(function (msg) { NK.functions.log(msg.responseText); });
  resultWFS.done(function (xml) {
    var exception = $(xml).find('ExceptionText').text();
    if (!!exception) {
      NK.functions.log(exception);
    } else {
      serviceParms['version'] = '1.1.0'; // we only support this atm
      $(xml).find('Service').each(function () {
        serviceParms['serviceTitle'] = $(this).children('Title').text();
      });
      $(xml).find('OutputFormats').each(function () {
        $(this).children('Format').each(function () {;
          formats[$(this).text()] = true;
        });
      });
      serviceParms['formats'] = Object.keys(formats);
      $(xml).find('AccessConstraints').each(function () {
        serviceParms['constraints'] = $(this).text();
      });
      var attribution;
      $(xml).find('Attribution').each(function () {
        var href = $(this).children('OnlineResource')[0];
        var logo = $(this).children('LogoURL').children('OnlineResource')[0];
        attribution = { 
          'title': $(this).children('Title').text(),
          'href' : href && href.getAttribute("xlink:href"),
          'logo' : logo && logo.getAttribute("xlink:href")
        }
      });
      if (!attribution) { attribution={'title':'missing', 'href':'#'}; }
      serviceParms['attribution'] = attribution;
      $(xml).find('DefaultSRS').each(function () {
        crs.push($(this).text());
      });
      $(xml).find('OtherSRS').each(function () {
        crs.push($(this).text());
      });
      $(xml).find('SpatialOperator[name="BBOX"]').each(function () {
        $(xml).find('GeometryOperand').each(function () {
          if ($(this).text() == "gml:Envelope") {
            serviceParms['bboxFilter'] = true;
          }
        });
      });
      serviceParms['crs'] = crs;
      $(xml).find('FeatureType').each(function () {
        layerParms = {};
        var name = $(this).children('Name').text();
        if (!name) {return;}
        layers.push(name);
        layerParms['title'] = $(this).children('Title').text();
        layerParms['visible'] = name in NK.visibleLayerQueue;
        if (name in NK.visibleLayerQueue) {delete NK.visibleLayerQueue[name];}
        if (name in NK.opacityQueue) {delete NK.opacityQueue[name];}
        layerParms['opacity'] = NK.opacityQueue[name] || 1.0;
        layerParms['type'] = name;
        NK.functions.createDynamicWFSLayer(layerParms['title'], wfsUrl, $.extend({},serviceParms, layerParms));
        if (!!NK.xdm) {
          NK.functions.postMessage({"type":"layerLoaded", "title":layerParms['title'], "url":wfsUrl}); 
        }
      });
      NK.functions.updateHistory();
    }
  });

  if (NK.controls.Geoportal) {
    //var geoportal =  map.getControlsByClass('OpenLayers.Control.Geoportal')[0];
    geoportal.showControls(wfsUrl);
    geoportal.displayLayerList();
  }
};

/** monkey patch to read GML elements outerBoundaryIs and innerBoundaryIs *************/
for (var i in ol.format.GML3.prototype) {
  if (!!ol.format.GML3.prototype[i]['http://www.opengis.net/gml']) {
    if (!!ol.format.GML3.prototype[i]['http://www.opengis.net/gml']['exterior']) {
      ol.format.GML3.prototype[i]['http://www.opengis.net/gml']['outerBoundaryIs'] = ol.format.GML3.prototype[i]['http://www.opengis.net/gml']['exterior'];
      ol.format.GML3.prototype[i]['http://www.opengis.net/gml']['innerBoundaryIs'] = ol.format.GML3.prototype[i]['http://www.opengis.net/gml']['interior'];
    }
  }
}
/** monkey patch to read GML Point with coordinates child *************/
ol.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_['http://www.opengis.net/gml']['coordinates'] = function(node, objectStack) {
  return ol.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_['http://www.opengis.net/gml']['posList'](node, objectStack);
}

/************************************************************/
/** monkey patch to accept any name space in ol.xml.parse ***/
ol.xml.parseNode = function(parsersNS, node, objectStack, opt_this) {
  if (!!parsersNS["*"]) {
    parsersNS[node.firstElementChild.namespaceURI] = parsersNS["*"];
  } 
  var n;
  for (n = node.firstElementChild; !goog.isNull(n); n = n.nextElementSibling) {
    var parsers = parsersNS[n.namespaceURI];
    if (goog.isDef(parsers)) {
      var parser = parsers[n.localName] || parsers[n.nodeName];
      if (goog.isDef(parser)) {
        parser.call(opt_this, n, objectStack);
      }
    }
  }
};


NK.functions.createDynamicWFSLayer = function (name, url, parms) {
  var crs = $.grep(parms['crs'], function(s) {
    return ($.inArray(s, NK.supportedCRS)>-1)
  })[0];
  var mimeFormat = 'text/xml; subtype=gml/3.2.1',
      format;
  for (var f in NK.supportedWFSFormats) {
    if (parms.formats.indexOf(NK.supportedWFSFormats[f])>-1) {
      mimeFormat = NK.supportedWFSFormats[f];
      break;
    }
  }
  if (mimeFormat.indexOf('gml')>-1) {
    format = new ol.format.WFS({
      featureNS:   '*', //see monkey patch above,
      //featureNS:   'http://mapserver.gis.umn.edu/mapserver', //FIXME: parms['namespace'],
      featureType: parms['type']
    });
  } else { 
    format = new ol.format.GeoJSON();
  }
  var source = new ol.source.ServerVector({
    format: format,
    loader: function(extent, resolution, projection) {
      var request = "/ws/px.py?" + url + "?service=WFS&version=1.1.0&request=GetFeature";
      //var request = url + "?service=WFS&version=1.1.0&request=GetFeature";
      request += "&typename=" + parms['type'];
      request += "&srsName=" + crs; 
      request += "&outputFormat=" + mimeFormat;
      //if (parms['bboxFilter']) {
      //  request += '&filter=<Filter%20xmlns="http://www.opengis.net/ogc"><BBOX><Envelope%20srsName="'+ crs +'"%20xmlns="http://www.opengis.net/gml"><lowerCorner>'+extent[0]+' '+extent[1]+'</lowerCorner><upperCorner>'+extent[2]+' '+extent[3]+'</upperCorner></Envelope></BBOX></Filter>';
      //} else {
      request += "&bbox="+extent.join(",");
      //}
      //request += "&bbox="+extent.join(",") + "," + crs;
      //request += "&bbox=" + ol.proj.transformExtent(extent, crs, 'EPSG:4326').join(",");
      $.ajax({url:request}).done(function(response) {
        var features = source.readFeatures(response);
        source.addFeatures(features);
      });
    }
  });
  var wfs = new ol.layer.Vector({
    source: source,
    style: NK.styles.wfs['default'],
    type: 'wfs',
    url:  url,
    featureType: parms['type'],
    dataFormats: parms['formats'],
    attribution: parms['attribution'],
    constraints: parms['constraints'],
    visible:     parms['visible'],
    opacity:     parms['opacity'], 
    isUrlDataLayer: true
  });

  map.addLayer(wfs);
  NK.functions.vector.addHoverControls(map, wfs, NK.styles.wfs.highlight); 
} 

NK.functions.addGeoJsonLayer = function (url, epsgCode, extensionProperties) {
  var mapProjection,
      layer,
      correctEpsgCode,
      layerExtensions;

  mapProjection = map.getView().getProjection();

  layer = new ol.layer.Vector({
    source: new ol.source.GeoJSON ({
      url: url
    }),
    style: function(feature, resolution) {
      var color = feature.get('color');
      if (!!color) { 
        var rgb = color.split(" ");
        var width = feature.get('size') || 2;
        var symbol = feature.get('symbol') || 'circle';
        var stroke = new ol.style.Stroke({
            color: [rgb[0],rgb[1],rgb[2],1],
            width: 2 
        });
        var fill = new ol.style.Fill({
            color: [rgb[0],rgb[1],rgb[2],0.8]
        });
        var pointStyle;

        if (symbol == 'square') {
          pointStyle = new ol.style.RegularShape({
            points: 4,
            angle: Math.PI/4,
            fill: fill,
            stroke: stroke,
            radius: width
          });
        } else {
          pointStyle = new ol.style.Circle({
            fill: fill,
            stroke: stroke,
            radius: width
          });
        }
        return [new ol.style.Style({
          fill: fill, 
          stroke: stroke, 
          image: pointStyle
        })];
      } else {
        return NK.styles.wfs['default'](feature, resolution);
      }
    },
    title: "drawing",
    shortid: 'urlDataLayer_' + NK.functions.urlDataLayerCounter,
    projection: mapProjection,
    displayInLayerSwitcher: false,
    isUrlDataLayer: true,
    type: 'geojson',
    url: url
  })

  $.extend(layer.values_, extensionProperties);

  map.addLayer(layer);
  NK.functions.vector.addHoverControls(map, layer, NK.styles.wfs.highlight);
};



// styles
  NK.styles = NK.styles || {};

var blueStyle = function(text) {
  return [new ol.style.Style({
    stroke: new ol.style.Stroke({
      color: [68,68,170,1],
      width: 2
    }),
    text: new ol.style.Text({
      font: '14px calibri, sans-serif',
      text: text,
      fill: new ol.style.Fill({
        color: [68,68,170,1]
      }),
      stroke: new ol.style.Stroke({
        color: "#fff",
        width: 4
      })
    }) 
  })]
};
var unlabeled = blueStyle("");

var blueHighlight = [new ol.style.Style({
  stroke: new ol.style.Stroke({
    color: "#aae",
    width: 2
  }),
  fill: new ol.style.Fill({
    color: [68,68,170,0.1]
  })
})]; 
var pointStyle = [new ol.style.Circle({
  radius: 10,
  stroke: new ol.style.Stroke({
    color: "#aae",
    width: 2
  })
})]; 

NK.styles.wfs = {
  "default": function(feature, resolution) { 
    if (feature.getGeometry().getType() == ol.geom.GeometryType.Point) {
      return pointStyle;
    } 
    if (resolution > 2000) {
      return unlabeled;
    } else {
      return blueStyle(feature.getId()); 
    }
  },
  "highlight": function(feature, resolution) { 
    return blueHighlight; 
  }
};




NK.styles = NK.styles || {};
NK.styles.dekning = NK.styles.dekning || {};
NK.styles.dekning.historisk = NK.styles.dekning.historisk || NK.styles.wfs;

NK.styles.dekning.historisk.popupBuilder = function(object) { 
  var id      = object.RuteID;
  var serie   = id.split("_")[0];
  var link100 = 'http://www.kartverket.no/historiske/'+serie+'/jpg100dpi/'+id+'.jpg';
  var link300 = 'http://www.kartverket.no/historiske/'+serie+'/jpg300dpi/'+id+'.jpg';
  var link_tn = 'http://www.kartverket.no/historiske/'+serie+'/216px/'+id+'.jpg';


  var str='<table>';
  str += '<tr><td colspan=2><img src="'+link_tn+'"></td></tr>';
  str += '<tr><td>Kartserie:</td><td>'+serie+'</td></tr>';
  str += '<tr><td>Last ned:</td><td><a href="'+link100+'">100dpi (webkvalitet)</a><br/><a href="'+link300+'">300dpi (trykkkvalitet)</a></td></tr>';
  str += '</tr></table>';
  return str;
};




NK.functions.resetTokenError = function () {
  if (NK.tokenError.pauseTimeRemainingElement) {
    NK.tokenError.pauseTimeRemainingElement.parentNode.removeChild(NK.tokenError.pauseTimeRemainingElement);
    NK.tokenError.pauseTimeRemainingElement = null;
  }
  if (NK.tokenError.messagePopup) {
    NK.tokenError.messagePopup.parentNode.removeChild(NK.tokenError.messagePopup);
    NK.tokenError.messagePopup = null;
  }
  if (NK.tokenError.pauseTimer) {
    clearTimeout(NK.tokenError.pauseTimer);
    NK.tokenError.pauseTimer = null;
  }
  if (NK.tokenError.pauseCountdownInterval) {
    clearInterval(NK.tokenError.pauseCountdownInterval);
    NK.tokenError.pauseCountdownInterval = null;
  }
};

NK.functions.updateToken = function (request) {
  var i, 
      j, 
      reloadLimit;

  reloadLimit = new Date(Date.now() - NK.tokenError.RELOAD_LIMIT_SECONDS * 1000);

  NK.gkToken = request.responseText.replace(/[\"\r\n]/g, '');

  if (NK.tokenLastUpdated < reloadLimit) { // was token updated less than RELOAD_LIMIT_SECONDS ago?
    if (!NK.tokenUpdatePaused) {
      NK.functions.resetTokenError();
      NK.tokenLastUpdated = new Date();

      for (i = 0, j = map.layers.length; i < j; i += 1) {
        if (map.layers[i].params && map.layers[i].params.gkt) {
          map.layers[i].params.gkt = NK.gkToken;
          map.layers[i].redraw();
        }
      }
    }
  } else {
    NK.functions.pauseTokenUpdate();
  }
};

NK.functions.pauseTokenUpdate = function () {
  var popup, innerWrapper, heading, message, timeRemaining, statusLink;

  if (!NK.tokenUpdatePaused) {
    NK.tokenUpdatePaused = true;

    NK.functions.log(OpenLayers.Lang.translate('Server error') +" - "+ OpenLayers.Lang.translate('An error has occured.'));

    NK.tokenError.pauseTimer = setTimeout(function () {
      NK.tokenUpdatePaused = false;
      NK.functions.getNewToken();
    },  60 * parseInt(NK.tokenError.PAUSE_MINUTES, 10) * 1000);

    NK.tokenError.pauseCountdownInterval = setInterval(function () {
      var content, timeLeft;
      if (NK.tokenError.pauseTimeRemainingElement) {
        content = NK.tokenError.pauseTimeRemainingElement.innerHTML;
        timeLeft = (parseInt(content, 10) - 1);
        NK.tokenError.pauseTimeRemainingElement.innerHTML = timeLeft.toString();
        if (timeLeft === 1) {
          if (NK.tokenError.pauseTimeRemainingText.textContent) {
            NK.tokenError.pauseTimeRemainingText.textContent = ' ' + OpenLayers.Lang.translate('minute.');
          } else {
            // old IE...
            NK.tokenError.pauseTimeRemainingText.innerText = ' ' + OpenLayers.Lang.translate('minute.');
          }
        }
      }
    }, 60 * 1000);
  }
};

NK.functions.getNewToken = function () {
  if (NK.gkToken !== null) {
    NK.gkToken = null;
    OpenLayers.Request.GET({url: NK.tokenService, success: NK.functions.updateToken});
  }
};

  
var NK = NK || {};
NK.functions = NK.functions || {};

NK.functions.updateHistory = function (evt) {
    var center,
        zoom,
        i,
        layer,
        uid,
        search,
        searchInput;

    if (!!map) {
        center = map.getView().getCenter();
        zoom = map.getView().getZoom();

        if (!!center && !!zoom) {
            uid = zoom + "/" + Math.round(center[0]) + "/" + Math.round(center[1]);

            map.getLayers().forEach(function(layer) {
                          if (!(layer.get('isBaseLayer') || layer.get('isHelper'))) {
                            if (!layer.get('isUrlDataLayer')) {
                                if (layer.getVisible()) {
                                  var id = layer.get('shortid');
                                        uid += "/+" + id;
                                }
                            } else if (layer.getVisible()) {
                                if (layer.get('type') == 'drawing') {
                                    uid += '/l/drawing/['+ layer.get('url') +']';
                                } else if (layer.get('type') == 'geojson') {
                                    uid += '/l/geojson/['+ layer.get('url') +']';
                                } else if (layer.get('type') == 'wms') {
                                    if (uid.indexOf(layer.getSource().getUrl())==-1) {
                                      uid += '/l/wms/[' + layer.getSource().getUrl() + ']';
                                    }
                                    var id = layer.getSource().getParams().LAYERS;
                                    if (id.indexOf("/")>-1) {
                                      uid += '/[+'+id+']';
                                    } else { 
                                      uid += '/+'+id;
                                    }
                                } else if (layer.get('type') == 'wfs') {
                                    if (uid.indexOf(layer.get('url'))==-1) {
                                      uid += '/l/wfs/[' + layer.get('url') + ']';
                                    }
                                    var id = layer.get('featureType');
                                    if (id.indexOf("/")>-1) {
                                      uid += '/[+'+id+']';
                                    } else { 
                                      uid += '/+'+id;
                                    }
                                    //for (var f in layer.selectedFeatures) {
                                    //  var centroid = layer.selectedFeatures[f].geometry.getCentroid();
                                    //  uid += "/!"+id+"!"+Math.round(centroid.x)+","+Math.round(centroid.y);
                                    //}
                                }
                                NK.functions.verifyDataLayers(layer);
                                if (!!layer.dataUrl) {
                                  uid += '/d/'+layer.dataType+'/['+layer.dataUrl.trim()+']';
                                }
                            }
                          if (layer.getOpacity()<1.0) {
                            uid += "/o"+Math.floor(layer.getOpacity() * 100);
                          }
                        }
            });
            $.each(NK.util.getLayersBy('title','pekere'), function(i,layer) {
              $.each(layer.getSource().getFeatures(), function(i,marker) {
                var xy = marker.getGeometry().getCoordinates();
                uid += "/m/"+xy[0]+"/"+xy[1]+"/"+marker.get('name');
              });
            });
        }
        searchInput = document.getElementById('searchInput');
        if (!!searchInput) {
            search = searchInput.value;
        }
        if (history.replaceState) {
           if (!!search) {
              history.replaceState({'search': 'sok=' + search, 'hash': uid}, document.title, '?sok=' + encodeURIComponent(search) + '#' + uid);
           } else {
              history.replaceState({'hash': uid}, document.title, '#' + uid);
           }
        } else {
           window.location.hash = uid;
        }
    }
};

 
// parameters for layers that are loaded asynchronously
NK.visibleLayerQueue = NK.visibleLayerQueue || {}; 
NK.opacityQueue = NK.opacityQueue || {}; 
NK.highlightQueue = NK.highlightQueue || {}; 

NK.functions.storeInitialLayerVisibility = function () {
  // store the initial layer visibility configuration
  var i, 
      layer;

  NK.initLayers = [];

  for (i in map.layers) {
    if (map.layers.hasOwnProperty(i)) {
      layer = map.layers[i];
      if (layer.visibility) {
        if ((!NK.defaultVisibleLayers || !$.inArray(layer.shortid, NK.defaultVisibleLayers)) && !layer.isUrlDataLayer) {
          NK.initLayers.push(layer.shortid);
        }
      }
    }
  }
};

NK.functions.setMapStateFromPopState = function (evt) {
  if (evt && evt.originalEvent && evt.originalEvent.state) {
    NK.functions.setMapState({'search': evt.originalEvent.state.search, 'hash': evt.originalEvent.state.hash});
  }
};

$(window).on('popstate', NK.functions.setMapStateFromPopState);

var markerStyle = new ol.style.Style({
  image: new ol.style.Icon({
    anchor: [12, 57],
    anchorXUnits: 'pixels',
    anchorYUnits: 'pixels',
    src: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAA5CAYAAACiXaIXAAAGqElEQVR4XtWZW2xURRjHv3PbW7vdC21XirBUSwFrsLUJaEKEkmLEhIYYX0pfIDE+aJr4YIwm8mRiYkiQR8XwICo1PpgIxoK9kEJt6qWxEohUpC2u7tJLtt3uLnvuxznhjFtncnJ23a6wX/LPNzObdH7z7zdnd+Ywhw4dgvsZ586dg2KDL2EyphTYrq4uA/5j8CWAOrWxDLoNBrFooyjoEmAZLKIPFDSdDaLPFAPPFwxLA7IEOPk5DZqXToDn4QsA5x2BaSdZnE2RYxjaAVYn2kW5zjsBE2IJcUSfcJwCNqVZGYvB7UJd5wsBJkFJEQsg61ongEkRGxIvpDinaWAalifEmdqxY8djfr//EY7j/IBCUZSFlZWV29evX/9tFaSKMxae0xpnset28LzDxsPAJKhgiW9tbX2yvr6+2+12P6NX1YU0dwh0zgWGAeBVshCSUtDY2DgvSdJQPB4/ixYwZa6HKCkMDHn37cuEL8BljoB1mbmtra29rq6uxxXa0CVG2iAViILGeRGsAToCNnSUrTYrZ+o9K9Pd0Zqr3Q0NDZ/FYrEzN27cuAUAMl0eGBC7be80Xcu0yxjY3dHR8Up1qP418eHdsLJuGxhggRLAeEzhfSCFWtDCtoM/ea2nqWqiJxKJvDMyMnKGhqYXgN2moB2AeQzc2dn5lmfdxqPZLV2gCtWOwLollFBmIBl8HNLeBtjAfnts37594eHh4ZMY0EaU27z9E4N2GU3S66mNHs1uexE0hi8OWM/3c0IIZjYchEbjq1f37NmTRI5/vPop4/QUYQmXgQD+B3rnzp27q4J1vdmmgyUB489lxgMzkWfBHwwfa25ubsQbm3j2MwQXhnYsD1NCOBw+LEY7QBOqSgW2xgDu8kFIBFohGo0eoaFp8GKg+V27du3lwtH9UvDRNQPG43d824Grru1paWnZSnwXMFh0eTi7zIdCoW4x0r62wLiPEOJVLYAehYdtygMcnKbgufXr14cFX81eORBdc2DD6i94NoPH43meKItCnaa1adOmJ1RfPejAlAXYlMIIkBOCAVQizTSwPTRj57bP59uqemvLBoyNuMsFIBAINNlsPoeNSLjOcVxA59zlA7b6MuMGQRDCNqci2mkHcQYwZQU2rM8cgoa2Ox5pmpZklFxZgc02b0igqmqKmL8gaCChRVGc5qSlsgKbYz4tDel0epoAXpVpaMNG+uzs7E+ubAJNoJcNmNNlqNaWAf1cnaLOjkiOThNnOi2RSCQ1MTPuyv5ZFmAz1ykxkMTclzIKc04C2BHaoM90oKZSqb6axZ/LAmzybRZ/hbm5uT5zLmJ++/KwOTlrWGNjYxfYpdkrnvTtNQVGI9Ag3QImu/DFLyjycxbvtEE6jaQsLy/31c6PAaPm1gzYo6WhWbwKqATPWudGtRBw1u5xR5ye1fHx8QF5+c4HDYlBRKGVDMzqMrRnL0NuJXn8Ggo8TyElwuIbTCenkeShoaETzNLs+WiiH1g1V5LDT2cGADLzpy9duvSRdcBVCGDCYefyMEhoDP5HLPapkZyBpjvnwX83VjTwQ/IsPJUZBC2VOD44OPgeAEj47xOlYQrsa5p2W6fdBtmU1+v1i6IIYjIBG+P9sHXhIgRyMUSp2gKzugIREzZ9EZqXLn89F5s+jBz+0AKWHeoZCrn3+Dc8ES6Xq5plWVA1DdKZDAjiTdiciUGT2wspIQIi6wOFcQFj6MAZCni0DITUeZAl8ZvFxcW+iYmJ74n/XqEbkIbGbuOTuQ20IQiC34Q2rFLA8IAk8EuAVgQsw9ybUddvZrPZdy9OTv6w6otDJaTRwPQGpKHt3QYC3OA5rgZDr5YZpvtgygzDUOLx+MvT09Oz9heQNHAx99O02zS4YYrluCCDnDQDZQyNQfGMgIw9gYCn6D1CX/cSDhMl6gBNg9OX3cjl4Gpg3DbD7DP38szU1NRJk528UCdB7WvY3nHilZzz64vO/fsvoNyJgbFW9yVJeuG70dEBh1+QhLM0cIHQzvAI+keU2ingfPvz4aGhI06HC6oESn9RRJcLhkcRJkHRGG5mkMtvWjVrBw1FwTo77aycKKZRqsZ9wvHXBwcG3neCwUaU+40tBnblgSlNIsdPIhgdyhwsFBdhsI9er8eDy6IioE8j4FH4n4LBG8pJzx04YKbdSFcIgCTSFisXHBf6+++r028TwA98eYwinUKCSoHWkHrNXDHQlsOTSPCgQ9dZ+S+kN/BgRThtAWcqCXoE6SwSVAp0NdJLSFBJ0J8g/V5p0KfgAYi/AQ0R+7KQtU9QAAAAAElFTkSuQmCC'
  })
});

NK.functions.addLabeledMarker = function (params, number) {
  var layer, feature, properties, x, y, popup, element;

  layer = NK.util.getLayersBy('shortid','pekere');
  if (layer.length) {
    layer = layer[0];
  } else {
    layer = new ol.layer.Vector({
      title: 'pekere',
      isHelper: true,
      source: new ol.source.Vector()
    });
    map.addLayer(layer);
  }

  x = parseInt(params[0], 10);
  y = parseInt(params[1], 10);

  properties = {};

  if (params.length > 2) {
    properties.name = decodeURIComponent(params[2]);
  }  
  if (number) {
    properties.nr = number;
  } else {
    properties.nr = '';
  }

  feature = new ol.Feature($.extend(properties,{
    geometry: new ol.geom.Point([x, y])
  }));
  feature.setStyle(markerStyle);

  element =  document.createElement('div');
  map.getViewport().appendChild(element);
  popup = new ol.Overlay({
    element: element,
    positioning: 'bottom-center',
    stopEvent: false
  });
  popup.setPosition([x,y]);
  popup.setOffset([9,-48]);
  map.addOverlay(popup);

  $(element).popover({
    placement: 'top',
    html: true,
    content: feature.get('name')
  });
  $(element).popover('show');

  layer.getSource().addFeature(feature);
  return feature;

};

NK.functions.verifyDataLayers = function(layer) {
  if (!!layer.dataUrl) {return;}
  for (var url in NK.dataLayers) {
    var data = NK.dataLayers[url];
    if (data.layerUrl == layer.url) {
      layer.dataUrl = url;
      layer.dataType = data.type;
      layer.dataName = data.name;
      layer.dataLayers = data.layers;
      layer.dataFormats = data.formats;
      layer.dataConstraints = data.constraints;
      layer.dataAttribution = data.attribution;
    }
  }
}

NK.functions.setDataLayer = function(params) {
  var type, url;
  if (!NK.lastParsedLayer) { 
    NK.functions.log(OpenLayers.Lang.translate("Data Layer provided without Portrayal Layer.<br/>Use /l/ before providing /d/."));
    return;
  } 
  type = params[0];
  url  = params[1];
  if (url.indexOf("%")>-1) { // you can URL-encode or escape or both
    url = decodeURIComponent(url);
  }
  switch (type) {
    case 'wcs':
      var last = NK.lastParsedLayer;
      NK.functions.loadWCSLayer(url, function(wcs) {
        NK.dataLayers[url] = {
          "type": type,
          "formats": wcs.formats,
          "layers": wcs.layers,
          "name": wcs.title,
          "attribution": wcs.attribution,
          "constraints": wcs.constraints,
          "layerUrl": last
        }
      });
      break;
  }
} 

NK.functions.parseParamsAndAddDataLayerFromUrl = function (params) {
  var type, url;

  type = params[0];
  url  = params[1];
  if (url.indexOf("%")>-1) { // you can URL-encode or escape or both
    url = decodeURIComponent(url);
  }

  switch (type) {
    case 'geojson':
      NK.functions.addGeoJsonLayer(url, "32633"); //FIXME: hardcoding EPSG code, should move to all WGS as per the latest GeoJSON memorandum
      break;
    case 'drawing':
      NK.functions.addGeoJsonLayer(url, "32633", {'isDrawing': true});
      break;
    case 'wms':
      NK.functions.addWMSLayer(url);
      break;
    case 'wfs':
      NK.functions.addWFSLayer(url);
      break;
    case 'wcs':
      NK.functions.log(OpenLayers.Lang.translate("Cannot display WCS directly. Use a Portrayal Service WMS with WCS as data layer.<br/>Syntax: /l/wms/[URL to portrayal]/d/wcs/[URL to data]"));
      break;
  }
  NK.lastParsedLayer = url;
};


NK.functions.highlightFeature = function(layer, fid, coords) { 
   // works for fid, does not work for spatial
   var filter; 

   if (!!coords) {
     var delta = 1;
     filter = new OpenLayers.Filter.Spatial({ type:  OpenLayers.Filter.Spatial.BBOX, 
                                              value: new OpenLayers.Bounds(coords[0]-delta, coords[1]-delta, (coords[0]-1)+delta, (coords[1]-1)+delta)
                                            });
   } else {
     filter = new OpenLayers.Filter.FeatureId({ fids: fid });
   }
   /* set a new renderer rule to highlight elements with the given name */
   layer.styleMap.styles['default'].addRules([
          new OpenLayers.Rule({
            filter: filter,
            symbolizer: {
              strokeWidth: 3,
              strokeColor : "orange",
              graphicZIndex: 2,
              fillColor : "orange",
              fillOpacity: 0.1
            }
          }),
          new OpenLayers.Rule({
            elseFilter: true,
            symbolizer: {}
          })
    ]);

    layer.styleMap.styles.temporary.addRules([
          new OpenLayers.Rule({
            filter: filter,
            symbolizer: {
              strokeWidth: 3,
              strokeColor: "yellow",
              fillColor  : "orange",
              fillOpacity: 0.2,
              graphicZIndex: 100
            }
          }),
          new OpenLayers.Rule({
            elseFilter: true,
            symbolizer: {}
          })
    ]);
};

NK.functions.urlDataLayerCounter = 0;
NK.functions.setMapState = function (params) {
  var parms,
      zoom,
      mapx,
      mapy,
      xy,
      index,
      extra,
      setLayerVisibility,
      setOpacity,
      showLayerNamed,
      hideLayerNamed,
      highlight,
      search,
      searchArray,
      searchInputField,
      i, j, p,
      hash,
      labeledMarkerCount = 0,
      pWSG84,
      pUTM33;

  var SAFE_SEQUENCE = "\n\n"; // a separator that cannot occur in URL

  search = params.search;
  hash = params.hash;


  if (params.search) {
    search = search.replace('?', '');
    searchArray = search.split('&');
    for (i = 0, j = searchArray.length; i < j; i += 1) {
      p = searchArray[i].split('=');
      if (p[0] === 'sok') {
        p[1] = decodeURIComponent(p[1]);
        searchInputField = document.getElementById('searchInput');
        if (searchInputField) {
          searchInputField.value = p[1];
        }
        //map.events.triggerEvent('searchForPhrase', {'phrase': p[1]});
      }
    }
  }

  if (!!hash) {
    var tokens = [], match;
    if (hash.indexOf("[") > -1) {
      var tokenRE = /\[.*?\]/g ;
      while(!!(match = tokenRE.exec(hash))) {
        tokens.push(match[0].slice(1,-1)); 
      }
      hash = hash.replace(tokenRE, SAFE_SEQUENCE);
    } else if (hash.indexOf("%5B") > -1) {
      var tokenRE = /\%5B.*?\%5D/g ;
      while(!!(match = tokenRE.exec(hash))) { 
        tokens.push(match[0].slice(3,-3)); 
      }
      hash = hash.replace(tokenRE, SAFE_SEQUENCE);
    }
    var parms = hash.split("/");
    for (p in parms) {
      if (parms[p] == SAFE_SEQUENCE) {
        parms[p] = tokens.shift(); // pop first
      }
    }
    if (parms.length >= 3) {
      zoom = parms[0];
      mapx = parms[1];
      mapy = parms[2];

      if ((mapy > 0) && (mapy < 35) && (mapx > 50) && (mapx < 90)) {  /* we are dealing with WSG84 coordinates here */
        xy = ol.proj.transform([mapy, mapx], 'EPSG:4326', map.getView().getProjection());
        mapx = xy.x;
        mapy = xy.y;
      }
    }

    setLayerVisibility = function (layer, visibility, opacity) {
      var i, 
          j,
          layer,
          layerSwitcherPresent;

      if (opacity === undefined) {opacity=1.0;}
      //layerSwitcherPresent =  map.getControlsByClass('OpenLayers.Control.RasterOverlayLayerSwitcher').length > 0;

      layer.setOpacity(opacity);
      //if (layerSwitcherPresent && visibility && layer.displayInLayerSwitcher && !layer.isBaseLayer && (layer.CLASS_NAME === "OpenLayers.Layer.WMTS" || layer.CLASS_NAME === "OpenLayers.Layer.WMS")) {
      //  map.events.triggerEvent('rasterLayerChangeRequest', {'shortId': layerName});
      //} else {
        layer.setVisible(visibility);
      //}
    };

    showLayerNamed = function (layerName) {
      NK.lastAddedLayer = layerName;
      var found = false;
      $(map.getLayers().getArray()).filter(function(i,l) {
        return (l.get('shortid') == layerName) || (l.get('title') == layerName); // TODO: or layer id for WMS
      }).each(function(i,l) {
        found = true;
        setLayerVisibility(l, true);
      });
      if (!found) {
        NK.visibleLayerQueue[layerName]=true;
      }
    };
    
    setOpacity = function(value) {
      if (!NK.lastAddedLayer) return;
      var matches = NK.util.getLayersBy('shortid', NK.lastAddedLayer);
      if (matches.length) {
        $.each(matches, function(i,l) {
          setLayerVisibility(l, true, parseInt(value)/100.0);
        });
      } else {
        NK.opacityQueue[NK.lastAddedLayer]=parseInt(value)/100.0;
      }
    }

    highlight = function (highlightParam) {
      var select, 
          layers,
          layer;

      select = highlightParam.slice(1).split("!");
      layers = map.getBy("layers", "shortid", select[0]);

      if (layers.length === 1) {
        layer = layers[0];
        //TODO: handle coordinates
        NK.functions.highlightFeature(layer, select[1]);
      } else {
        var q = NK.highlightQueue[select[0]] || [];
        if (select[1].indexOf(",")>-1) {
          q.push([select[0], null, select[1].split(",")]);
        } else {
          q.push([select[0], select[1], null]);
        }
        NK.highlightQueue[select[0]] = q;
      }
    }


    for (index = 3; index < parms.length; index += 1) {
      extra = parms[index];
      switch (extra.charAt(0)) {
        case '+':
          showLayerNamed(extra.slice(1));
          break;
        case '!':
          highlight(extra);
          break;
        case 'o':
          setOpacity(extra.slice(1));
          break;
        case 'm':
          setTimeout(
            (function (boundParameters, boundCounter){
              return function () {
                NK.functions.addLabeledMarker(boundParameters, boundCounter);  
              };
            }(parms.slice(index + 1, index + 4), ++labeledMarkerCount)),
            500
          );
          index += 3;
          break;
        case 'l':
          NK.functions.parseParamsAndAddDataLayerFromUrl(parms.slice(index + 1, index + 3));
          index += 2;
          break;
        case 'd':
          NK.functions.setDataLayer(parms.slice(index + 1, index + 3))
          index += 2;
          break; 
      }
    }
    if (mapx && mapy && zoom) {
      map.getView().setCenter([parseInt(mapx), parseInt(mapy)]);
      map.getView().setZoom(zoom);
    }
  }
};

NK.functions.setMapStateFromURL = function () {
  // adjust layer visibility and pan/zoom based on hash, if available

  var hash,
      search;

  search = window.location.search;
  hash = window.location.href.split("#")[1]; // avoids window.location.hash because Firefox automatically decodes URI encoded hashes


  NK.functions.setMapState({'search': search, 'hash': hash});
};



NK.init = function () {
  var prmstr, prmarr, params, tmparr, 
      i, j;

  if ((!ol) || (!proj4)) {
    setTimeout(NK.init, 100);
    return;
  }

  // TODO: cleanup projection loading
  var extents = {
      'EPSG:3857': [-180, -90, 180, 90],
      'EPSG:25833': [-2500000, 3500000, 3045984, 9045984],
      'EPSG:32633': [-2500000, 3500000, 3045984, 9045984]
  };
  
  proj4.defs("EPSG:25833","+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
  proj4.defs("EPSG:32633","+proj=utm +zone=33 +datum=WGS84 +units=m +no_defs");
  proj4.defs("EPSG:25832","+proj=utm +zone=32 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
  proj4.defs("EPSG:32632","+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs");
  proj4.defs("urn:ogc:def:crs:EPSG::25833","+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
  proj4.defs("urn:ogc:def:crs:EPSG::32633","+proj=utm +zone=33 +datum=WGS84 +units=m +no_defs");
  
  NK.projections = proj = {  
    //pregenerated projection objects
    "25833": new ol.proj.Projection({ code:"EPSG:25833", extent:extents["EPSG:25833"], units:ol.proj.Units.METERS }),
    "32633": new ol.proj.Projection({ code:"EPSG:32633", extent:extents["EPSG:25833"], units:ol.proj.Units.METERS }),
    "ogc25833": new ol.proj.Projection({ code:"urn:ogc:def:crs:EPSG::25833", extent:extents["EPSG:25833"], units:ol.proj.Units.METERS }),
    "ogc32633": new ol.proj.Projection({ code:"urn:ogc:def:crs:EPSG::32633", extent:extents["EPSG:25833"], units:ol.proj.Units.METERS })
  };
  ol.proj.addEquivalentProjections(goog.object.getValues(proj)); //they all are.
  for (var p in proj) {
  //  ol.proj.addProjection(proj[p]);
    ol.proj.addCoordinateTransforms(proj[p], ol.proj.get('EPSG:4326'), proj4(proj[p].getCode()).inverse, proj4(proj[p].getCode()).forward);
  }
  proj["3857"] = new ol.proj.Projection({code:"EPSG:3857", extent:extents["EPSG:3857"], units: ol.proj.Units.DEGREES });  

  mapProj = proj[NK.baseProjection];

  // TODO

  // extract URL parameters into dictionary
  prmstr = window.location.search.substr(1);
  prmarr = prmstr.split ("&");
  params = {};

  for (i = 0, j = prmarr.length; i < j; i += 1) {
    tmparr = prmarr[i].split("=");
    params[tmparr[0]] = tmparr[1];
  }

  // Create map canvas

  if (!!params.proj) {
    mapProj = proj[params.proj]; 
  }

 
  // Default placement and zoom of the map
  NK.defaultCenter = [378604,7226208];
NK.defaultZoom = 5;


  NK.view = new ol.View({
    projection: mapProj,
    extent:     mapProj.getExtent(),
    center:     NK.defaultCenter,
    zoom:       NK.defaultZoom
  });

  NK.mapOptions = {
    target: 'map',
    view  : NK.view,
    interactions: [], 
    controls: []
  };
  map = new ol.Map(NK.mapOptions);


  // Overlays
  
(function () {
  var url, 
      options = {};

    url = NK.mapservers.wmts;

    options.displayInLayerSwitcher = true;


    options.layerGroup = "flere";









  NK.addLayerType.WMTS('enkel', 'enkel', url, 'norges_grunnkart', options);

}());


NK.functions = NK.functions || {};
NK.functions.vector = NK.functions.vector || {};
NK.functions.popup = NK.functions.popup || {};

var skipKeys = ["boundedBy", "geometry", "msGeometry"];
NK.functions.popup.ify = function(object) {
  if (!goog.isDefAndNotNull(object)) {
    return "-";
  }
  if (goog.isString(object)) {
    if (object.indexOf("://")>-1) {
      return "<a href='"+object+"'>"+object+"</a>";
    }
    return object;
  }
  if (goog.isNumber(object)) {
    return object;
  }
  var keys = Object.keys(object);
  if ((keys.length == 1) && (keys[0] == "text_")) {
    if (object.text_.indexOf("://")>-1) {
      return "<a href='"+object.text_+"'>"+object.text_+"</a>";
    }
    return object.text_;
  }
  var str="<table>", value;
  for (var k in object) {
    if (skipKeys.indexOf(k)>-1) { continue; }
    if ((k == "text_") && (object[k].trim() == "")) { continue; }
    value = NK.functions.popup.ify(object[k]);
    str += "<tr><td>"+k+":</td><td>"+value+"</td></tr>";
  }
  str += "</tr></table>";
  return str;
}

NK.functions.vector.addSelectControls = function (map, layer, style, featureIdentity) {
  var select = new ol.interaction.Select();
  select.on("change:active", function(evt) { 
    if (NK.functions.postMessage) {
      var message = {
        cmd: 'featureSelected',
        feature: feature.getId(),
        attributes: feature.values_,
        layer: layer.get('shortid')
      };
      NK.functions.postMessage(message);
    }
  });

  layer.on('change:visible', function(evt) {
    if (layer.getVisible()) {
      map.addInteraction(select);
    } else {
      map.removeInteraction(select);
    }
  });
  if (layer.getVisible()) {
    map.addInteraction(select);
  } 
};

NK.functions.vector.addHoverControls = function (map, layer, style, featureIdentity, popupBuilder) {
  if (!featureIdentity) {featureIdentity = Object.is;}
  if (!popupBuilder)    {popupBuilder    = NK.functions.popup.ify;}

  var featureOverlay = new ol.FeatureOverlay({
    map: map,
    style: style
  });

  var highlight=[];
  var mouseHint = document.createElement("div");
  mouseHint.className = "ol-mouse-hint";
  map.getOverlayContainer().appendChild(mouseHint);
  mouseHint.style.visibility = false;

  var displayFeatureInfo = function(pixel) {
    var feature, geom, geom2;
    map.forEachFeatureAtPixel(pixel, function(f, layer) {
      if (!!feature) { 
        geom = f.getGeometry(); 
        geom2 = feature.getGeometry();
        // TODO: mixed geometries?
        if (goog.isDef(geom.getLength) && 
                   (geom2.getLength() <= geom.getLength())) {
          return;
        } else if (goog.isDef(geom.getArea) &&
                   (geom2.getArea() <= geom.getArea())) {
          return; 
        }
      }
      feature = f; 
    });
    if (!(highlight.length && featureIdentity(feature, highlight[0]))) {
      if (highlight.length) {
        for (var h in highlight) {
          featureOverlay.removeFeature(highlight[h]);
        }
        highlight = [];
      }
      mouseHint.style.visibility = 'hidden';
      if (!!feature) {
        highlight = $.grep(layer.getSource().getFeatures(), function(f) {
          return featureIdentity(feature, f);
        });
        for (var h in highlight) {
          featureOverlay.addFeature(highlight[h]);
        }
        mouseHint.style.visibility = 'visible';
      }
    }
    if (!!feature) {
      mouseHint.innerHTML = popupBuilder(feature.values_);
      $.extend(mouseHint.style, {
        left: pixel[0]+10+"px",
        top: pixel[1]+15+"px"
      });
    }
  };

  var mousemoveFn = function(evt) {
    displayFeatureInfo(map.getEventPixel(evt.originalEvent));
  };

  layer.on('change:visible', function(evt) {
    if (layer.getVisible()) {
      $(map.getViewport()).on('mousemove', mousemoveFn);
    } else {
      $(map.getViewport()).off('mousemove', mousemoveFn);
    }
  });
  if (layer.getVisible()) {
    $(map.getViewport()).on('mousemove', mousemoveFn);
  } 

};








(function (M, MP, P) {
  var layer,
      selectControl,
      onPopupClose = null,
      onFeatureUnselect,
      onFeatureSelect,
      generatePopupMarkup,
      requestHandler;

  // dekningsoversikt - vector layer
  layer = new ol.layer.Vector({
    title: "Generalkart",
    shortid: "dekning.h.gen", 
    style: NK.styles.dekning.historisk["default"],
    visible: 0,
    layerGroup: "dekning.h",
    preferredBackground: "land",

    source: new ol.source.GeoJSON({ 
      url: "http://norgeskart.no/json/dekning/historisk/General.geojson"
    }) 
  });

  M.addLayer(layer);

  NK.functions.vector.addHoverControls(map, layer, NK.styles.dekning.historisk.highlight, Object.is, NK.styles.dekning.historisk.popupBuilder);
  NK.functions.vector.addSelectControls(map, layer, NK.styles.dekning.historisk.highlight, Object.is);

}(map, mapProj, proj));


  // Baselayers
  
NK.addLayerType = NK.addLayerType || {};
NK.addLayerType.WMTS = (function (M, MP) {
  var matrixIds = [],
      resolutions = [],
      i;
  var extent = map.getView().getProjection().getExtent();
  var size = ol.extent.getWidth(extent) / 256;

  for (i = 0; i <= NK.zoomLevels; ++i) {
    matrixIds[i] = [];
    resolutions[i] = size / Math.pow(2, i);
    matrixIds[i] = MP.getCode() + ":" + i;
  } 


  return function (id, name, url, layer, options) {
    var layer, 
        layerOptions;
    var myMatrixIds = [],
        customOrigin,
        customExtent;

    if (options.shortMatrixIds) {
      for (i = 0; i <= NK.zoomLevels; ++i) {
        myMatrixIds.push( ""+i);
      }
    }
   
     
    if (options.tileOrigin) {
      customOrigin = options.tileOrigin.split(",");
    }
    if (options.databbox) {
      customExtent = options.databbox.split(",");
    }

    var sourceOptions ={
        layer: layer,
        matrixSet: options.customProj || MP.getCode(),
        projection: MP,
        format: "image/png",
        tileGrid: new ol.tilegrid.WMTS({ 
          origin: customOrigin || ol.extent.getTopLeft(extent),
          resolutions: resolutions,
          matrixIds: myMatrixIds.length ? myMatrixIds : matrixIds
        }),
        crossOrigin: 'anonymous',
        attributions: [new ol.Attribution({html: "<a href='http://kartverket.no/Kart/Gratis-kartdata/Lisens/'>CC-BY</a> <a href='http://kartverket.no'>Kartverket</a>"})]
    };
    if (typeof(url)==='string') {
      sourceOptions['url']=url;
    } else { 
      sourceOptions['urls']=url;
    }
    if (!!customExtent) {
      sourceOptions['extent'] = customExtent;
    } 
    var source = new ol.source.WMTS(sourceOptions);

    layerOptions = {
      title: name,
      source: source,
      shortid: id, 
      layerGroup: options.layerGroup || null,
      isBaseLayer: !!options.isBaseLayer,
      visible: !!options.visible
    };

    if (!!customExtent) {
      layerOptions['extent'] = customExtent;
    } 
    if (!!options.minResolution) {
      layerOptions['minResolution']=options.minResolution;
    }

    layer = new ol.layer.Tile(layerOptions);

    M.addLayer(layer);
    return layer;
  };
}(map, mapProj));



(function () {
  var url, 
      options = {};

    url = NK.mapservers.wmts;

    options.displayInLayerSwitcher = true;

    options.visible = true;

    options.layerGroup = "modus1";


    options.isBaseLayer = true;

    options.minResolution = 150;






  NK.addLayerType.WMTS('europa', 'Europa', url, 'egk', options);

}());


var controlContext = map;
var container = null;
var collect = null;

  var interactions=ol.interaction.defaults().array_;
var controls    =ol.control.defaults().array_;
for (var i in interactions) {
  map.addInteraction(interactions[i]);
}
map.addControl(new ol.control.ScaleLine({units:ol.control.ScaleLineUnits.METRIC}));

NK.status = document.createElement("div");
NK.status.setAttribute("class","toolbar");
NK.status.setAttribute("id","status");
NK.status.messages = {};
document.body.appendChild(NK.status);

NK.status.refresh = function() {
  var content = "", msg, height;
  var now = new Date().getTime();
  for (msg in NK.status.messages) { 
    if (now > parseInt(msg) + 20000) {
      delete NK.status.messages[msg];
    }
  }
  for (msg in NK.status.messages) { 
    content += '<div class="statusmsg">'+NK.status.messages[msg]+'</div>';
  }
  NK.status.innerHTML = content;

  if (!!Object.keys(NK.status.messages).length) {
    $("#status").animate({"max-height": "200px"}); 
  } else {
    $("#status").animate({"max-height": "0px"}); 
  }
};

NK.functions.log = function(msg) {
  var now = new Date().getTime();
  NK.status.messages[new Date().getTime()] = msg;
  NK.status.refresh();
  setTimeout(NK.status.refresh, 21000);
  return now;
};
NK.functions.updateLog = function(time, msg) {
  delete NK.status.messages[time];
  NK.functions.log(msg);
};

(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "panel";
}


  container = document.createElement("div");
    container.id = "basic-toolbar";



  container.className = className;
  parentContainer.appendChild(container);




	(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "panel";
}


  container = document.createElement("div");
    container.id = "fullscreen-panel";



  container.className = className;
  parentContainer.appendChild(container);




	
NK.functions = NK.functions || {};

/**
 *  used by controls templates to place controls in the correct context
 *
 */
NK.functions.addControlToContext = function (control, context) {
  // utility method to add control to map or panel

  if (context.addControl) {
    // context is a map
    context.addControl(control);
  } else if (context.addControls) {
    // context is a panel
    context.addControls([control]);
  }
};




(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	

NK.controls = NK.controls || {};
NK.controls.Fullscreen = function(options) {
  options = options || {};
  var wrapper, btn;
  var cName = 'fullscreen-button nkButton';
  
  this.title = "Fullscreen";

  wrapper = document.createElement('div');
  btn    = document.createElement('button');
  wrapper.appendChild(btn);

  btn.title = this.title;
  btn.className = cName;
  btn.innerHTML = '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" preserveAspectRatio="xMidYMid meet" viewBox="0 0 20 20" class="icon fullscreen"><path d="M14.949,3.661l1.429,1.428l1.539-1.54l1.612,1.612V0.485h-4.676l1.636,1.636L14.949,3.661z M17.894,16.6l-1.54-1.539l-1.428,1.428l1.539,1.54l-1.611,1.612h4.676v-4.676L17.894,16.6z M4.895,16.465l-1.428-1.428l-1.54,1.539l-1.612-1.611v4.676h4.675l-1.636-1.637L4.895,16.465z M3.491,5.064l1.428-1.428l-1.54-1.539l1.612-1.612H0.315v4.675l1.636-1.635L3.491,5.064zM15.769,12.033V8.199c0-1.587-1.288-2.875-2.875-2.875H6.907c-1.588,0-2.875,1.287-2.875,2.875v3.834c0,1.588,1.287,2.875,2.875,2.875h5.987C14.48,14.908,15.769,13.621,15.769,12.033z" /></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 20 20" preserveAspectRatio="xMidYMid meet" class="icon windowed"><path d="M19.877,1.61l-1.523-1.533l-1.642,1.653L14.992,0v5.021h4.987l-1.745-1.756L19.877,1.61z M16.737,18.253l1.643,1.653l1.522-1.533l-1.642-1.653l1.719-1.73h-4.987v5.02L16.737,18.253z M0.103,18.399l1.523,1.533l1.642-1.654l1.719,1.731v-5.021H0l1.745,1.756L0.103,18.399z M1.6,0.104L0.077,1.637L1.719,3.29L0,5.021h4.987V0L3.243,1.756L1.6,0.104z M15.759,12.038V8.204c0-1.587-1.288-2.875-2.875-2.875H6.897c-1.588,0-2.875,1.287-2.875,2.875v3.834c0,1.588,1.287,2.875,2.875,2.875h5.987C14.471,14.913,15.759,13.626,15.759,12.038z" /></svg>';

  this.btn = btn;

  $(btn).click(this, this.toggle);
  
  ol.control.Control.call(this, {
    element: wrapper,
    target: options.target
  });

}
ol.inherits(NK.controls.Fullscreen, ol.control.Control);

NK.controls.Fullscreen.prototype.toggle = function(event) {
  var self = event.data; 
  if (self.is_full_screen_on === true ) {
            self.disable();
            self.showControls();
            self.is_full_screen_on = false;
  } else {
            self.enable();
            self.hideControls();
            self.is_full_screen_on = true;            
  } // endif
};

NK.controls.Fullscreen.prototype.enable = function () {
        var el = document.documentElement,
            rfs = // for newer Webkit and Firefox
                   el.requestFullscreen
                || el.webkitRequestFullScreen
                || el.mozRequestFullScreen
                || el.msRequestFullScreen;
        if (rfs !== "undefined" && rfs) {
            rfs.call(el);
        } else if (typeof window.ActiveXObject !== "undefined") {
            // for Internet Explorer
            try {
                var wscript = new ActiveXObject("WScript.Shell");
                if (wscript !== null) {
                    wscript.SendKeys("{F11}");
                }
            } catch (e) {
                // proceed with minimized control panels. Full screen activation prohibited by browser security settings.
            }
        }
};

NK.controls.Fullscreen.prototype.disable = function () {
        // cancel method belongs to document directly
        var cfs = // for newer Webkit and Firefox
                   document.cancelFullScreen
                || document.webkitCancelFullScreen
                || document.mozCancelFullScreen
                || document.exitFullscreen
                || document.msCancelFullScreen;
        if (cfs !== "undefined" && cfs) {
            cfs.call(document);
        } else if (typeof window.ActiveXObject !== "undefined") {
            // for Internet Explorer
            try {
                var wscript = new ActiveXObject("WScript.Shell");
                if (wscript !== null) {
                    wscript.SendKeys("{F11}");
                }
            } catch (e) {
            }
        } // endif
};

NK.controls.Fullscreen.prototype.hideControls = function () {        
        $(this.elemsToHideSelector).not("." + this.panelClass).hide();
        $(document.body).addClass("fullscreen");
        $(this.btn).addClass("fullscreen-active");
};


NK.controls.Fullscreen.prototype.showControls = function () {
        $(this.elemsToHideSelector).show();
        $(document.body).removeClass("fullscreen");
        $(this.btn).removeClass("fullscreen-active");
};


NK.functions.addControlToContext(new NK.controls.Fullscreen({target: container}), context);


}(controlContext, container));

}(controlContext, container, collect));

(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "panel";
}


  container = document.createElement("div");
    container.id = "zoom-panel";



  container.className = className;
  parentContainer.appendChild(container);




	

(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	

//TODO
NK.controls = NK.controls || {};
NK.controls.ZoomPanel = function(options) {
  var wrapper, sliderWrapper, buttonWrapper;
  var zoomIn, zoomOut;

  options = options || {};
  
  wrapper = document.createElement('div');
  wrapper.className = "zoombar-and-buttons-wrapper";
  wrapper.style.height = "70px";

  sliderWrapper = document.createElement('div');
  sliderWrapper.classname = "sliderWrapper";

  buttonWrapper = document.createElement('div');
  buttonWrapper.classname = "wrapper";
  
  zoomIn = document.createElement('button');
  zoomIn.className = "olControlZoomIn olButton";
  zoomIn.title = "Zoom inn";
  zoomIn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="64px" height="64px" version="1.1" preserveAspectRatio="xMidYMid meet" viewBox="0 0 64 64" class="plus icon"><path fill-rule="evenodd" d="m 14,27.5 13.5,0 0,-13.5 9,0 0,13.5 13.5,0 0,9 -13.5,0 0,13.5 -9,0 0,-13.5 -13.5,0 z M 63,32 C 63,49.120827 49.120827,63 32,63 14.879173,63 1,49.120827 1,32 1,14.879173 14.879173,1 32,1 49.120827,1 63,14.879173 63,32z"></path></svg>';

  zoomOut = document.createElement('button');
  zoomOut.className = "olControlZoomOut olButton";
  zoomOut.title = "Zoom ut";
  zoomOut.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="64px" height="64px" version="1.1" preserveAspectRatio="xMidYMid meet" viewBox="0 0 64 64" class="minus icon"><path fill-rule="evenodd" d="m 14,27.5 36,0 0,9 -36,0 zM 63,32 C 63,49.120827 49.120827,63 32,63 14.879173,63 1,49.120827 1,32 1,14.879173 14.879173,1 32,1 49.120827,1 63,14.879173 63,32z"></path></svg>';

  zoomIn.addEventListener("click", this.zoom(1), false);
  zoomOut.addEventListener("click", this.zoom(-1), false);

  buttonWrapper.appendChild(zoomIn);
  buttonWrapper.appendChild(zoomOut);

  wrapper.appendChild(buttonWrapper);

  ol.control.Control.call(this, {
    element: wrapper,
    target: options.target
  });

}
ol.inherits(NK.controls.ZoomPanel, ol.control.Control);

NK.controls.ZoomPanel.prototype.zoom = function(dir) {
  return function() {
    var view = map.getView();
    var zoom = ol.animation.zoom({
      duration: 100,
      resolution: view.getResolution()
    });
    map.beforeRender(zoom);
    view.setZoom(view.getZoom()+dir);
  }
}


NK.functions.addControlToContext(new NK.controls.ZoomPanel({target: container}), context);

}(controlContext, container));



(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	

//TODO
NK.controls = NK.controls || {};
NK.controls.ZoomToSelection = function(options) {
  var wrapper, btn; 

  options = options || {};
  this.container = options.target;  

  this.dragzoom = new ol.interaction.DragZoom({
    condition: ol.events.condition.always
  });

  btn = document.createElement('button');

  btn.title = "Zoom to selection";
  btn.style.cursor = "pointer";
  btn.innerHTML = '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="26" viewBox="0 0 32 26" preserveAspectRatio="xMidYMid meet" class="icon zoom-to-selection"><g class="selection-dots"><circle cx="2" cy="2"  r="1.5" /><circle cx="2" cy="8"  r="1.5" /><circle cx="2" cy="14" r="1.5" /><circle cx="2" cy="20" r="1.5" /><circle cx="8"  cy="2"  r="1.5" /><circle cx="8"  cy="20" r="1.5" /><circle cx="14" cy="2"  r="1.5" /><circle cx="14" cy="20" r="1.5" /><circle cx="20" cy="2"  r="1.5" /><circle cx="20" cy="20" r="1.5" /><circle cx="26" cy="2"  r="1.5" /><circle cx="26" cy="8"  r="1.5" /><circle cx="26" cy="14" r="1.5" /><circle cx="26" cy="20" r="1.5" /></g><path class="crosshair" d="M25,19v-4h3v4h4v3h-4v4h-3v-4h-4v-3z" /></svg>';
  btn.className = "zoom-to-selection-button";

  $(btn).click(this, this.toggle);

  ol.control.Control.call(this, {
    element: btn,
    target: options.target
  });

}
ol.inherits(NK.controls.ZoomToSelection, ol.control.Control);

NK.controls.ZoomToSelection.prototype.enable = function() {
  $(this.container).addClass("zoom-to-selection-selected");
  map.addInteraction(this.dragzoom);

};
NK.controls.ZoomToSelection.prototype.disable = function() {
  $(this.container).removeClass("zoom-to-selection-selected");
  map.removeInteraction(this.dragzoom);
};
NK.controls.ZoomToSelection.prototype.toggle = function(event) {
  var self = event.data;
  if (map.getInteractions().getArray().indexOf(self.dragzoom)>-1) {
    self.disable();
  } else {
    self.enable();
  }
};


NK.functions.addControlToContext(new NK.controls.ZoomToSelection({target: container}), context);

}(controlContext, container));

}(controlContext, container, collect));

(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "panel";
}


  container = document.createElement("div");
    container.id = "pan-panel";



  container.className = className;
  parentContainer.appendChild(container);




	

(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	

//TODO
NK.controls = NK.controls || {};
NK.controls.PanPanel = function(options) {
  var wrapper,nord, ost, vest, sor;

  options = options || {};
  
  wrapper = document.createElement('div');

  nord = document.createElement('button');
  nord.title = "nordover";
  $(nord).addClass("olControlPanNorthItemInactive olButton");
  options.target.appendChild(nord);

  sor = document.createElement('button');
  sor.title = "s&oslash;rover";
  $(sor).addClass("olControlPanSouthItemInactive olButton");
  options.target.appendChild(sor);

  ost = document.createElement('button');
  ost.title = "&oslash;stover";
  $(ost).addClass("olControlPanEastItemInactive olButton");
  options.target.appendChild(ost);

  vest = document.createElement('button');
  vest.title = "vestover";
  $(vest).addClass("olControlPanWestItemInactive olButton");
  options.target.appendChild(vest);

  nord.addEventListener("click", this.pan(0,1), false);
  sor.addEventListener("click", this.pan(0,-1), false);
  vest.addEventListener("click", this.pan(-1,0), false);
  ost.addEventListener("click", this.pan(1,0), false);

  ol.control.Control.call(this, {
    element: wrapper,
    target: options.target
  });

}
ol.inherits(NK.controls.PanPanel, ol.control.Control);

NK.controls.PanPanel.prototype.pan = function(x,y) {
  return function(evt) {
    var view = map.getView();
    var center = view.getCenter();
    var res  = view.getResolution();
    var PAN_DISTANCE = 100;
 
    var pan = ol.animation.pan({
      duration: 250,
      source: center
    });
    map.beforeRender(pan);
    view.setCenter([center[0] + x * res * PAN_DISTANCE, center[1] + y * res * PAN_DISTANCE]);
  };
}


NK.functions.addControlToContext(new NK.controls.PanPanel({target: container}), context);

}(controlContext, container));

}(controlContext, container, collect));

(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "panel";
}


  container = document.createElement("div");
    container.id = "layerselector-panel";



  container.className = className;
  parentContainer.appendChild(container);




	

(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	
        options.group = "modus1";



NK.controls = NK.controls || {};
NK.controls.LayerSelector = function(options) {
  var wrapper, layerList, inputElem, labelSpan, li, trigger; 
  var i, len, layer, checked;
  var layers;
  options = options || {};

  this.group = options.group;
  this.dataLayers = [];

  wrapper = document.createElement("div");
  wrapper.className = "layersDiv";
  layers  = NK.util.getLayersBy('layerGroup', this.group);

  if (layers.length) {
    layerList = document.createElement('ul');
  }
  for (i = 0, len = layers.length; i < len; i++) {
    layer = layers[i];

    if ((this.group && this.group === layer.get('layerGroup')) || this.group === null) {
      if (!(layer.get('isBaseLayer') || layer.get('isHelper'))) {
        checked = layer.getVisible();
    
        // create input element
        inputElem = document.createElement("input");
        inputElem.type = "radio";
        inputElem.value = layer.get('title');
        inputElem.checked = checked;
        inputElem.defaultChecked = checked;
        inputElem.className = "olButton";
        if (checked) {
          $(inputElem).addClass("is-checked");
        }
        inputElem._layer = layer;
        inputElem._layerSwitcher = this;

        // create span
        labelSpan = document.createElement("label");
        labelSpan["for"] = inputElem.id;
        $(labelSpan).addClass("labelSpan olButton");
        if (checked) {
          $(labelSpan).addClass("for-checked");
        }
        labelSpan._layer = layer;
        labelSpan._layerSwitcher = this;
        labelSpan.innerHTML = layer.get('title');

        // create list item
        li = document.createElement("li");
        li.id = layer.get('shortid').replace(/\./g, '-') + '-selector';
        $(li).addClass('raster-layer-selector-item');

        if (layer.get('hideFromLayerSwitcher')) {
          $(li).addClass('hidden');
        }

        this.dataLayers.push({
          'layer': layer,
          'inputElem': inputElem,
          'labelSpan': labelSpan
        });

        trigger = document.createElement('span');
        $(trigger).addClass('layerTriggerTarget');
        $(labelSpan).click({
          selector: this,
          inputElem: inputElem,
          labelSpan: labelSpan,
          layer   : layer
        }, this.activate);

        labelSpan.appendChild( trigger );
        li.appendChild(inputElem);
        li.appendChild(labelSpan);
        layerList.appendChild(li);		
      }
    }
  }
  if (layerList) {
    layerList.className = "rasterLayerList";
    if (options.popup) {
      this.toggleWidgetDiv = document.createElement("div");
      $(this.toggleWidgetDiv).addClass("vectorWidgetToggleBtn");
      this.toggleWidgetDiv.tabIndex = 0;
      this.toggleWidgetDiv.innerHTML = options.title;

      this.widget = document.createElement("div");
      this.widget.className = 'widget';
      this.layerList = layerList;
      this.widget.appendChild(this.layerList);
      wrapper.appendChild(this.toggleWidgetDiv);
      wrapper.appendChild(this.widget);

      $(this.toggleWidgetDiv).click(this, function( event ) {
        var self   = event.data;
        var parent = self.toggleWidgetDiv.parentNode;
        $(parent).toggleClass('show' );
        var widget = self.layerList.parentElement;
        var offset = widget.getBoundingClientRect().bottom - $(window).height();
        if (offset > 0) {
          widget.style.top = widget.style.top.split("px")[0] - offset - 5 + "px"; // don't you love mixed type?
        }
      });
    } else {
      wrapper.appendChild(layerList);
    }
  }
  options.target = document.getElementById('layerswitcher');
  ol.control.Control.call(this, {
    element: wrapper,
    target: options.target
  });
}
ol.inherits(NK.controls.LayerSelector, ol.control.Control);

NK.controls.LayerSelector.prototype.activate =  function(event) {
  var rasterControls, i;
  var self  = event.data.selector;
  var layer = event.data.layer;

  if (!self.disabled) {
    rasterControls = NK.util.getControlsByClass(NK.controls.LayerSelector);
    for (i = 0; i < rasterControls.length; i++) { 
      rasterControls[i].hideAll();
    }
    layer.setVisible(true);
    $(event.data.inputElem).addClass('is-checked');
    $(event.data.labelSpan).addClass('for-checked');
    if (self.toggleWidgetDiv) {
      $(self.toggleWidgetDiv.parentNode).addClass('show');
    }
  }
};

NK.controls.LayerSelector.prototype.hideAll =  function() {
  for (var l in this.dataLayers) {
    this.dataLayers[l].layer.setVisible(false);
    $(this.dataLayers[l].inputElem).removeClass('is-checked');
    $(this.dataLayers[l].labelSpan).removeClass('for-checked');
  }
  if (this.toggleWidgetDiv) {
    $(this.toggleWidgetDiv.parentNode).removeClass('show');
  }
}



goog.object.extend(options, {
  target: container
});
NK.functions.addControlToContext(new NK.controls.LayerSelector(options), context);

}(controlContext, container));



(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	
        options.group = "sjo";
        options.popup = true;
        options.title = "Sj&oslash;";


goog.object.extend(options, {
  target: container
});
NK.functions.addControlToContext(new NK.controls.LayerSelector(options), context);

}(controlContext, container));



(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	
        options.group = "modus2";


goog.object.extend(options, {
  target: container
});
NK.functions.addControlToContext(new NK.controls.LayerSelector(options), context);

}(controlContext, container));



(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	
        options.group = "flere";
        options.popup = true;
        options.title = "Flere";


goog.object.extend(options, {
  target: container
});
NK.functions.addControlToContext(new NK.controls.LayerSelector(options), context);

}(controlContext, container));



(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	
        options.group = "dekning.h";
        options.popup = true;
        options.title = "Historiske serier";


goog.object.extend(options, {
  target: container
});
NK.functions.addControlToContext(new NK.controls.LayerSelector(options), context);

}(controlContext, container));

}(controlContext, container, collect));

}(controlContext, container, collect));

(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "panel";
}

  container = document.createElement('nav');
  container.id = "top-toolbar";
  container.className = className + ' navbar-inverse';

  var innerContainer = document.createElement('div');
  innerContainer.className = 'container-fluid';

  var header = document.createElement('div');
  header.className = 'navbar-header';

  header.innerHTML = '<button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar-collapse-1"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button>';
  header.innerHTML += ' <a class="navbar-brand" href="http://kartverket.no" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="513px" height="181px" viewBox="0 0 513 181" class="kartverket logo" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Kartverket"><title>Kartverket</title><g class="text"><path d="M152.264,89.083h6.806v56.253h-6.806V89.083z M167.024,115.487l22.468,29.85h-8.61l-21.484-29.768l21.648-26.486h8.61L167.024,115.487z"/><path d="M226.408,146.894c-2.788-0.902-4.838-3.115-5.576-5.986c-3.936,3.938-7.134,5.494-11.808,5.494c-10.086,0-13.12-6.148-13.12-11.643c0-9.268,7.954-14.68,21.648-14.68c0.902,0,1.558,0,2.87,0.082v-2.869c0-3.607-0.164-5.084-1.312-6.396c-1.312-1.477-2.952-2.213-5.494-2.213c-4.592,0-10.414,2.459-13.038,4.838l-3.198-4.592c5.412-3.609,11.234-5.494,17.138-5.494c5.658,0,9.594,2.213,11.316,6.395c0.902,2.215,0.984,5.33,0.902,9.021l-0.328,13.447c-0.164,6.643,0.246,8.365,3.28,10.004L226.408,146.894z M217.06,124.427c-10.332,0-14.022,3.525-14.022,9.758c0,4.838,2.378,7.461,7.052,7.461c4.182,0,8.036-2.541,9.922-6.395l0.246-10.66C219.438,124.509,217.962,124.427,217.06,124.427"/><path d="M258.772,110.649c-0.409-0.164-1.147-0.328-1.805-0.328c-2.459,0-4.919,1.066-6.805,2.953c-1.886,1.885-2.378,3.115-2.378,6.477v25.586h-6.396v-31.488c0-5.33-1.148-8.119-1.394-8.693l6.396-1.721c0.328,0.654,1.558,3.607,1.312,6.641c2.952-4.182,7.298-6.805,11.479-6.805c0.985,0,1.968,0.328,2.214,0.41L258.772,110.649z"/><path d="M287.783,109.337h-8.529v26.322c0,4.512,1.23,6.068,5.248,6.068c1.805,0,2.871-0.246,4.02-0.82l0.9,4.102c-2.049,1.064-4.346,1.639-7.215,1.639c-2.133,0-3.771-0.41-5.33-1.146c-2.871-1.395-3.936-4.02-3.936-8.119v-28.045h-5.33v-4.838h5.33c0-3.525,0.492-9.02,0.656-10.332l6.723-1.475c-0.164,1.311-0.82,6.969-0.82,11.807h10.25L287.783,109.337z"/><path d="M317.695,145.747h-6.314l-14.678-40.92l6.561-1.393l9.512,28.125c0.984,2.953,1.805,6.232,1.969,6.971h0.164c0.164-0.656,0.818-3.607,1.967-6.888l9.348-27.144h6.807L317.695,145.747z"/><path d="M346.451,125.982v0.985c0,3.854,0.492,6.806,1.887,8.938c2.297,3.527,6.068,5.002,10.168,5.002c3.936,0,7.135-1.229,10.004-3.854l2.461,4.1c-3.609,3.281-8.529,5.084-13.777,5.084c-11.316,0-18.121-8.199-18.121-21.729c0-6.889,1.475-11.316,4.919-15.416c3.28-3.855,7.298-5.658,12.218-5.658c4.43,0,8.282,1.557,11.07,4.428c3.527,3.607,4.674,7.461,4.674,17.219v0.901H346.451z M363.262,112.044c-1.396-2.215-4.264-3.607-7.379-3.607c-5.822,0-9.104,4.264-9.432,12.709h18.697C365.066,116.718,364.491,114.013,363.262,112.044"/><path d="M401.352,110.649c-0.41-0.164-1.148-0.328-1.805-0.328c-2.459,0-4.92,1.066-6.805,2.953c-1.887,1.885-2.379,3.115-2.379,6.477v25.586h-6.396v-31.488c0-5.33-1.148-8.119-1.393-8.693l6.395-1.721c0.328,0.654,1.559,3.607,1.312,6.641c2.953-4.182,7.299-6.805,11.48-6.805c0.984,0,1.969,0.328,2.213,0.41L401.352,110.649z"/><path d="M412.592,145.337v-50.35c0-4.755-0.82-7.79-1.066-8.363l6.396-1.23c0.246,0.656,1.066,4.099,1.066,9.675v50.268H412.592z M438.012,145.337l-18.777-23.125l15.58-17.713h8.037l-16.072,17.713l19.762,23.125H438.012z"/><path d="M458.02,125.982v0.985c0,3.854,0.492,6.806,1.887,8.938c2.297,3.527,6.068,5.002,10.168,5.002c3.936,0,7.135-1.229,10.004-3.854l2.461,4.1c-3.609,3.281-8.529,5.084-13.777,5.084c-11.316,0-18.121-8.199-18.121-21.729c0-6.889,1.475-11.316,4.92-15.416c3.279-3.855,7.297-5.658,12.217-5.658c4.43,0,8.283,1.557,11.07,4.428c3.527,3.607,4.674,7.461,4.674,17.219v0.901H458.02z M474.83,112.044c-1.395-2.215-4.264-3.607-7.379-3.607c-5.822,0-9.104,4.264-9.432,12.709h18.697C476.635,116.718,476.061,114.013,474.83,112.044"/><path d="M511.057,109.337h-8.527v26.322c0,4.512,1.23,6.068,5.248,6.068c1.805,0,2.871-0.246,4.018-0.82l0.902,4.102c-2.049,1.064-4.346,1.639-7.215,1.639c-2.133,0-3.773-0.41-5.33-1.146c-2.871-1.395-3.938-4.02-3.938-8.119v-28.045h-5.33v-4.838h5.33c0-3.525,0.492-9.02,0.656-10.332l6.725-1.475c-0.164,1.311-0.82,6.969-0.82,11.807h10.25L511.057,109.337z"/></g><path class="outline" d="M9.538,0C4.272,0,0.002,4.271,0.002,9.54V172.152C0,176.729,4.272,181,9.538,181H114.46c5.266,0,9.537-4.271,9.537-9.539V9.538C124,4.271,119.726,0,114.46,0"/><path fill="#00963E" d="M111.575,4.992H12.423c-4.977,0-9.013,4.036-9.013,9.014v60.802c7.782-5.92,17.521-14.199,35.091-9.864C53.64,68.681,56.94,80.351,80.888,93.609c14.66,8.115,28.414,1.853,39.703-4.703v-74.9C120.591,9.028,116.552,4.992,111.575,4.992"/><path fill="#0058A3" d="M88.628,120.735c-4.939-0.604-8.781-2.312-12.557-4.761c-8.386-5.178-16.433-13.646-33.542-22.528c-13.63-6.622-26.924-1.573-39.106,5.37l-0.014,0.007v68.171c0,4.978,4.036,9.014,9.014,9.014h99.152c4.977,0,9.014-4.036,9.014-9.014v-55.576C110.007,117.484,99.847,122.412,88.628,120.735"/><path fill="#FFFFFF" d="M80.888,93.609C56.941,80.352,53.641,68.682,38.5,64.944c-17.569-4.335-27.308,3.944-35.091,9.864l0.017,12.266L3.424,98.816c12.182-6.944,25.657-12.352,39.107-5.37c17.107,8.882,25.154,17.349,33.541,22.528c3.82,2.359,7.711,4.035,12.558,4.761c11.217,1.676,21.377-3.253,31.961-9.318l-0.029-10.847l0.029-11.665C109.302,95.463,95.548,101.725,80.888,93.609"/></svg></a>';

  var collectDiv = document.createElement('div');
  collectDiv.className = 'collapse navbar-collapse';
  collectDiv.id = 'navbar-collapse-1';

  collect = document.createElement('ul');
  collect.className = 'nav navbar-nav';

  collectDiv.appendChild(collect);

  innerContainer.appendChild(header);
  innerContainer.appendChild(collectDiv);

  container.appendChild(innerContainer);
  parentContainer.appendChild(container);


	(function (context, containerParam, collect) {

  var html = '<li class="dropdown">';
      html += '<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Se andre karttjenester <span class="caret"></span></a>';
        html += '<ul class="dropdown-menu" role="menu">';
        html += '<li><a href="http://norgeskart.no/" target="_blank">Norgeskart</a></li>';
        html += '<li role="presentation" class="divider"></li>';
        html += '<li><a href="http://norgeskart.no/ssr" target="_blank">Stedsnavn</a></li>';
        html += '<li><a href="http://norgeskart.no/tilgjengelighet" target="_blank">Tilgjengelighet</a></li>';
        html += '<li><a href="http://norgeskart.no/nrl" target="_blank">NRL</a></li>';
        html += '<li><a href="http://norgeskart.no/fastmerker" target="_blank">Fastmerker</a></li>';
      html += '</ul>';
      html += '</li>';

  collect.innerHTML = html;

}(controlContext, container, collect));

(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "panel";
}

  container = document.createElement("li");
    container.id = "search-panel";


  container.className = className;
  collect.appendChild(container);


	

(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	

        options.coordinates = "http://norgeskart.no/ws/trans.py";
        options.searchUrl = "https://ws.geonorge.no/SKWS3Index/ssr/sok";
        options.streetAddressesSearchUrl = "http://norgeskart.no/ws/veg.py";
        options.addressSearchUrl = "http://norgeskart.no/ws/adr.py";
        options.propertySearchUrl = "http://norgeskart.no/ws/eie.py";


NK.controls = NK.controls || {};
NK.controls.Search = function(options) {
  options = options || {};
  var element, formElem, inputElem, divgroup,
      inputResultsPerPage, inputResultPageNumber,
      submitBtn, searchFunction;

  goog.object.extend(this, options);

  goog.object.extend(this, {
    searchData: {
      ssr      : null,
      register : null,
      address  : null
    },
    searchRequests : {
        ssr       : null,
        register  : null,
        gbrnr     : null,
        address   : null
    },
    submitBtnId: "searchSubmit",
    resultsPerPage: 15,
    markerLayer: null,
    menu : null,
    timer : null,
    searchTimer: null,
    lastPhrase : null,
    closeButtonHtml: null
  });


  element = document.createElement('div');
  element.className = 'searchDiv';

  formElem = document.createElement('form');
  formElem.setAttribute('action', options.searchUrl);
  formElem.setAttribute('class', 'navbar-form navbar-left');
  formElem.setAttribute('role', 'search');
  formElem.onsubmit = function () {return false};

  divgroup = document.createElement('div');
  divgroup.setAttribute('class', 'input-group');
  inputElem = document.createElement('input');
  inputElem.setAttribute('name', 'searchInput');
  inputElem.setAttribute('id', 'searchInput');
  inputElem.setAttribute('class', 'form-control');
  inputElem.setAttribute('type', 'search');
  inputElem.setAttribute('autocomplete', 'off');
  inputElem.setAttribute('autocorrect', 'off');
  inputElem.setAttribute('autocapitalize', 'off');
  inputElem.setAttribute('spellcheck', 'false');
  inputElem.setAttribute('placeholder', 'Find place, coordinates, address');
        
  inputResultsPerPage = document.createElement('input');
  inputResultsPerPage.setAttribute('name', 'searchResultsPerPage');
  inputResultsPerPage.setAttribute('id', 'searchResultsPerPageInput');
  inputResultsPerPage.setAttribute('value', this.resultsPerPage);
  inputResultsPerPage.setAttribute('type', 'hidden');

  inputResultPageNumber = document.createElement('input');
  inputResultPageNumber.setAttribute( 'name', 'searchResultsPageNumber' );
  inputResultPageNumber.setAttribute( 'id', 'searchResultsPageNumberInput' );
  inputResultPageNumber.setAttribute( 'value', '0' );
  inputResultPageNumber.setAttribute( 'type', 'hidden' );
        
  submitBtn = document.createElement( 'span' );
  submitBtn.setAttribute( 'type', 'submit' );
  submitBtn.setAttribute( 'id', this.submitBtnId );
  submitBtn.setAttribute('class', 'submit-button input-group-addon');
  submitBtn.innerHTML = '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="439px" height="438px" viewBox="0 0 439 438" class="icon search" preserveAspectRatio="xMidYMid meet"><path d="M432.155,368.606l-2.64-2.639l0.005-0.004l-105.53-105.539c14.662-25.259,23.18-54.54,23.379-85.837C347.985,78.772,270.817,0.612,175.01,0.01c-0.387-0.001-0.761-0.002-1.145-0.002C78.595,0.012,1.045,76.951,0.431,172.366c-0.605,95.81,76.561,173.967,172.359,174.579c0.379,0.002,0.751,0.004,1.133,0.004c31.845,0,61.686-8.627,87.357-23.63l105.439,105.45l0.009-0.01l2.638,2.636c7.973,7.975,20.897,7.967,28.871,0l33.918-33.917C440.124,389.511,440.128,376.578,432.155,368.606z M173.07,302.708c-71.252-0.456-128.852-58.802-128.401-130.059c0.456-70.798,58.414-128.399,129.198-128.403l0.864,0.002c34.518,0.216,66.884,13.863,91.137,38.426c24.251,24.564,37.485,57.105,37.262,91.63c-0.216,34.371-13.767,66.64-38.149,90.859c-24.376,24.212-56.715,37.545-91.058,37.545L173.07,302.708z"/></svg>' + '<span>Search</span>';
        
  formElem.appendChild(inputResultsPerPage);
  formElem.appendChild(inputResultPageNumber);
  divgroup.appendChild(inputElem);
  divgroup.appendChild(submitBtn);
  formElem.appendChild(divgroup);
  element.innerHTML = '';
  element.appendChild(formElem);

  var that = this;

  searchFunction = function(e) {
                var searchInput = $('#searchInput'),
                    resultsList = $('#searchResults'),
                    loadingNotice = $('#searchLoadingNotice'),
                    newValue    = searchInput.val().trim(),
                    searchTimer;

                if ( e.keyCode == 13 ) {
                   return false;
                }
                
                if (newValue.length < 2) {

                   resultsList.remove();
                   if (that.searchTimer) window.clearTimeout(searchTimer);
                   that.abortRequests();

                   var markerLayer = that.getMarkerLayer();
                   if (markerLayer) {
                       markerLayer.getSource().clear();
                       markerLayer.setVisibility(false);
                   }
                   return false;
                } else {
                    if (newValue === that.lastPhrase) {
                        // Same phrase as before, ignore key event
                        return false;
                    }
                    if (that.searchTimer) window.clearTimeout(searchTimer);
                    that.lastPhrase = newValue;
                }
                if ( resultsList.length === 0 ) {
                    resultsList = $( '<div/>', { 'id': 'searchResults', html : options.closeButtonHtml});
                    $('.searchDiv').after(resultsList);
                }

                resultsList.html(options.closeButtonHtml);
                if (loadingNotice.length === 0) {
                    loadingNotice = $('<div/>', {'id':'searchLoadingNotice', html: 'Searching...'});
                }
                resultsList.append(loadingNotice);
                resultsList.show();

                $('#searchResults a.close').on( "click", function(e){
                    $('#searchResults').remove();
                    if (that.searchTimer) window.clearTimeout(searchTimer);
                    that.abortRequests();
                    return false; 
                });

                that.searchTimer = setTimeout(function() {
                    // launch with delay
                    if ( that.lastPhrase == $('#searchInput').val() ) {
                        if (NK.functions && NK.functions.updateHistory) {
                            NK.functions.updateHistory();
                        }
                        $('#searchResultsPageNumberInput').val(0);
                        that.doSearch();
                    }
                }, 1000);
  };
          
  $(document).on("keyup",  '#searchInput', searchFunction); 
  $(document).on("search", '#searchInput', searchFunction); 
          
  $(document).on("click", '.search-place', function(){
            var center = [$(this).data("east"), $(this).data("north")]; 
            center = ol.proj.transform(center, 'EPSG:4326', map.getView().getProjection());
            
            var zoom, dzoom;
            dzoom = $(this).data("zoom");
            if ( dzoom > map.getView().getZoom() ) {
                zoom = dzoom;
            } else {
                zoom = map.getView().getZoom();
            }
            if ($(this).parent().parent().hasClass('addresses')) zoom = 15;
            
            map.getView().setCenter(center);
            map.getView().setZoom( zoom );
            $('#searchResults').remove();
  });  

  $(element).click(this, this.onClick);
 
  ol.control.Control.call(this, {
    element: element,
    target: options.target
  });

}
ol.inherits(NK.controls.Search, ol.control.Control);

NK.controls.Search.prototype.doSearch = function (phraseParameter, page, pageLength) {

        // returning test data
        var phrase = phraseParameter || $('#searchInput').val(),
            resultsPageNumber = page || $('#searchResultsPageNumberInput').val(),
            resultsPerPage = pageLength ||$('#searchResultsPerPageInput').val(),
            params,
            self = this;

        phrase = phrase.trim(phrase);
        self.lastPhrase = phrase;

        /*
            Parallel register search for addresses
        */
        var registerSearch = {            
            url: this.streetAddressesSearchUrl,
            run: function(params, search){

                search.searchData.register = null;

                var request,
                    requestParams = encodeURIComponent(params.phrase);

                $.support.cors = true;

                request = $.ajax({
                    url: this.url,
                    data: requestParams,
                    dataType: 'JSON',
                    crossDomain: true
                });

                request.done(function(data){
                    search.searchData.register = data;
                    if (search.searchData.ssr !== null) {
                        search.drawResponse();
                    }
                });

                request.fail(function(xhr, status, exc){
                    search.searchData.register = null;
                    //console.log('Request failed: ' + status + ', ' + exc);
                });

                if (self.searchRequests.register !== null) {
                    self.searchRequests.register.abort();
                }
                self.searchRequests.register = request;
            }
        };
        var searchAddress = {
            url: this.addressSearchUrl,
            run: function(params, search){
                search.searchData.address = null;

                var request,
                    requestParams = encodeURIComponent(params.phrase);

                $.support.cors = true;

                request = $.ajax({
                    url: that.addressSearchUrl,
                    data: requestParams,
                    dataType: 'JSON',
                    crossDomain: true
                });

                request.done(function(data){
                    search.searchData.address = data;
                    if (search.searchData.ssr !== null) {
                        search.drawResponse();
                    }
                });

                request.fail(function(xhr, status, exc){
                    search.searchData.address = null;
                    //console.log('Request failed: ' + status + ', ' + exc);
                });

                if (self.searchRequests.address !== null) {
                    self.searchRequests.address.abort();
                }
                self.searchRequests.address = request;

            }// run
        };
        var searchEngine = {
            url: this.searchUrl,
            paramNames: {
                name: 'navn',
                //fylkeKommuneListe: 'fylkeKommuneListe',
                fylkeKommuneNavnListe: 'fylkeKommuneNavnListe',
                maxResult: 'antPerSide',
                northLL: 'nordLL',
                eastLL: 'ostLL',
                northUR: 'nordUR',
                eastUR: 'ostUR',
                exactMatchesFirst: 'eksaktForst',
                page: 'side'
            },
        
            run: function (params, search) {
                if (params.phrase == '*') {return;}

                search.searchData.ssr = null;

                var request,
                    requestParams = {};

                params.phrase = params.phrase.split(',');
                if (params.phrase.length >= 2 ){
                  requestParams[this.paramNames.name] = params.phrase[0] + "*";
                  requestParams[this.paramNames.fylkeKommuneNavnListe] = params.phrase[1].substring(0, params.phrase[1].length - 1);
                } else {
                  requestParams[this.paramNames.name] = params.phrase[0];
                }
                requestParams[this.paramNames.exactMatchesFirst] = true;
                requestParams[this.paramNames.maxResult] = params.resultsPerPage;
                requestParams['epsgKode'] = '4326';
                requestParams[this.paramNames.page] = params.resultsPageNumber;

                $.support.cors = true;

                request = $.ajax({
                    url: this.url,
                    data: requestParams,
                    dataType: 'xml',
                    crossDomain: true
                }); // request

                request.done(function(data){
                    search.searchData.ssr = data;
                    if (search.searchData.register !== null) {
                        search.drawResponse();
                    }
                    //search.drawResponse(data);
                });// done

                request.fail(function(xhr, status, exc) {
                    search.searchData.ssr = null;
                    // console.log( "Request failed: " + status + ', ' + exc);
                });// fail

                if (self.searchRequests.ssr !== null) {
                    self.searchRequests.ssr.abort();
                }
                self.searchRequests.ssr = request;

            } // run
        }; // searchEngine
        var that = this;
        var gbrnrSearchEngine = {
            url: this.propertySearchUrl,

            run: function (params, search) {

                var request,
                    query = '';

                query += params.municipality + '-' + params.numbers.join('/');
                $.support.cors = true;

                that.lastParams = params;

                request = $.ajax({
                    url: this.url + '?' + encodeURIComponent(query),
                    crossDomain: true
                }); // request

                request.done(function(response){
                    var parsedResponse = $.parseJSON(response);
                    var place, key, keys, k, i, j;
                    if (parsedResponse && parsedResponse.length > 0) {
                      var places = [];
                      for (i = 0; i < parsedResponse.length; i++) {
                        var r = parsedResponse[i];
                        if (!r['LONGITUDE']) {
                          that.displaySearchNotice('Search results contain properties without known borders. We cannot display these, but you can repeat your search on <a href="http://www.seeiendom.no" target="_blank" style="color:#fff">seeiendom.no</a> to retrieve more information.');
                          continue; // TODO: Error message - property has no known geometries 
                        }
                        var point = [parseFloat(r['LONGITUDE']), parseFloat(r['LATITUDE'])];
                        point = ol.proj.transform(point, "EPSG:32632", "EPSG:4326");
                        var p = that.lastParams.numbers;
                        place = {
                            name: r['NAVN'],
                            address: r['VEGADRESSE'],
                            type: r['OBJEKTTYPE'],
                            municipality: r['KOMMUNENAVN'],
                            county: r['FYLKESNAVN'],
                            north: point[1],
                            east: point[0]
                        };
                        places.push(place);
                        if (parsedResponse && (parsedResponse.length == 1)) {
                          point = ol.proj.transform(point,"EPSG:4326", map.getView().getProjection());
                          map.getView().setCenter(point);
                        }
                      }
                      that.addMarkers(places);
                    }
                });// done

                request.fail(function(xhr, status, exc) {
                    // console.log( "Request failed: " + status + ', ' + exc);
                });// fail

                if (self.searchRequests.gbrnr !== null) {
                    self.searchRequests.gbrnr.abort();
                }
                self.searchRequests.gbrnr = request;

            } // run
        }; // searchEngine

        params = this.parseInput(phrase);

        if (params) {
            if (typeof params.phrase === 'string') {
                
                registerSearch.run(params, this);

                searchAddress.run(params, this);

                params.phrase = params.phrase + '*';
                params.resultsPageNumber = resultsPageNumber;
                params.resultsPerPage = resultsPerPage;
                
                searchEngine.run(params, this);

            } else if (params.north || params.x) {

                var inputEPSG = params.projectionHint || "4326",
                    inputName = "WGS84/Geografisk grader";

                if (params.north) {
                    var center = [params.east, params.north];          
                    var fromProj = proj[inputEPSG];
                } else {
                    var center = [params.x, params.y];
                    var inputProj = $.localStorage.get("inputCRS") || "23";
                    var inputEPSG = params.projectionHint || this.trf().getEPSGfromSOSI(inputProj);
                    if (!this.trf().isViewable(inputEPSG)) {
                      var inputProj = "23";
                      var inputEPSG = this.trf().getEPSGfromSOSI(inputProj);
                    }
                    if (!params.projectionHint) {
                      var searchInput = $('#searchInput');
                      var caretPos    = searchInput.caret();
                      searchInput.val(searchInput.val().split("@")[0] + "@" + inputEPSG);
                      searchInput.caret(caretPos);
                    }
                    var fromProj = proj[inputEPSG];
                    var pointToNorthEast = [params.x, params.y];
                    pointToNorthEast.transform(fromProj, proj["4326"]);
                    params.north = pointToNorthEast[1];
                    params.east = pointToNorthEast[0];
                }
                var inputName = this.trf().getCRSName(inputEPSG);
                var toProj   = map.getView().getProjection();
                center.transform(fromProj, toProj);
                map.getView().setCenter(center);
                this.addMarkers([params]);

                if (inputEPSG != "4326") {
                  var coordinateSystemSelector = this.trf().generateCoordinateSystemsList('coordinate-system-selector', 'Coordinate system:', inputProj, true);
                  coordinateSystemSelector.select.setAttribute('onchange', "NK.util.getControlsByClass('NK.contros.Search')[0].changeProjection(this)");


                  var noticeElement = this.displaySearchNotice('Koordinatene tolkes som <a href="http://epsg.io/' + inputEPSG + '" target="_blank" style="color:#fff">' + inputName + '</a>.<br />Bytt projeksjon til ');

                  noticeElement.appendChild(coordinateSystemSelector.select); // huh, shouldn't there be a direct way to do this?
                }
            } else if (params.gnr) {
                this.displaySearchNotice('Search for properties as follows:<br/>Municipality-Gardsnr/Bruksnr/Feste/Seksjon<br/>e.g.: <b>Ringerike-38/98</b></br/> or by entering an address.');
                gbrnrSearchEngine.run(params, this);
            }
        } 
};

NK.controls.Search.prototype.parseInput = function (input) {
        var parsedInput = {},
            reResult,
            decimalPairComma,
            decimalPairDot,
            decimalCoordinatesNE,
            degMinNE,
            degMinEN,
            degMinSecNE,
            degMinSecEN,
            degMinSecEN2,
            gbrnr, gbrnr2, gbrnr3, gbrnr4, gbrnr5;

        // matches two numbers using either . or , as decimal mark. Numbers using . as decimal mark are separated by , or , plus blankspace. Numbers using , as decimal mark are separated by blankspace
        decimalPairComma = /^[ \t]*([0-9]+,[0-9]+|[0-9]+)[ \t]+([0-9]+,[0-9]+|[0-9]+)(?:@([0-9]+))?[ \t]*$/;
        decimalPairDot   = /^[ \t]*([0-9]+\.[0-9]+|[0-9]+)(?:[ \t]+,|,)[ \t]*([0-9]+\.[0-9]+|[0-9]+)(?:@([0-9]+))?[ \t]*$/; 
        decimalCoordinatesNE = /^[ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*[°]?[ \t]*[nN][ \t]*,?[ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*[°]?[ \t]*[eEøØoO][ \t]*$/;
        degMinNE = /^[ \t]*([0-9]+)[ \t]*[°][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*['′][ \t]*[nN]?[ \t]*,?[ \t]*([0-9]+)[ \t]*[°][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*['′][ \t]*[eEoOøØ]?[ \t]*?/;
        degMinEN = /^[ \t]*([0-9]+)[ \t]*[°][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*['′][ \t]*[eEoOøØ][ \t]*,?[ \t]*([0-9]+)[ \t]*[°][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*['′][ \t]*[nN][ \t]*?/;
        degMinSecNE = /^[ \t]*[nN]?[ \t]*([0-9]+)[ \t]*[°][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*['′][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*(?:"||''||′′)[ \t]*[nN]?[ \t]*,?[ \t]*[eEøØoO]?[ \t]*([0-9]+)[ \t]*[°][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*['′][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*(?:"||''||′′)[ \t]*[eEoOøØ]?[ \t]*?/;
        degMinSecEN = /^[ \t]*([0-9]+)[ \t]*[°][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*['′][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*(?:"||''||′′)[ \t]*[eEøØoO][ \t]*,?[ \t]*([0-9]+)[ \t]*[°][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*['′][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*(?:"||''||′′)[ \t]*[nN][ \t]*?/;
        degMinSecEN2 = /^[ \t]*[eEøØoO][ \t]*([0-9]+)[ \t]*[°][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*['′][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*(?:"||''||′′)[ \t]*,?[ \t]*[nN][ \t]*([0-9]+)[ \t]*[°][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*['′][ \t]*([0-9]+[,\.][0-9]+|[0-9]+)[ \t]*(?:"||''||′′)[ \t]*?/;
        gbrnr = /^[ \t]*([A-Za-zæøåÆØÅ ]+[A-Za-zæøåÆØÅ]|[\d]+)[ \t]*[-/][ \t]*([\d]+)[ \t]*[/][ \t]*([\d]+)[ \t]*$/;
        gbrnr2 = /^[ \t]*([A-Za-zæøåÆØÅ ]+[A-Za-zæøåÆØÅ]|[\d]+)[ \t]*[-/][ \t]*([\d]+)[ \t]*[/][ \t]*([\d]+)[ \t]*[/][ \t]*([\d]+)[ \t]*$/;
        gbrnr3 = /^[ \t]*([A-Za-zæøåÆØÅ ]+[A-Za-zæøåÆØÅ]|[\d]+)[ \t]*[-/][ \t]*([\d]+)[ \t]*[/][ \t]*([\d]+)[ \t]*[/][ \t]*([\d]+)[ \t]*[/][ \t]*([\d]+)[ \t]*$/;
        gbrnr4 = /^[ \t]*([\d]+)[ \t]*[/][ \t]*([\d]+)[ \t]*[ \t]*[,]([A-Za-zæøåÆØÅ ]*)$/;
        gbrnr5 = /^[ \t]*([\d]+)[ \t]*[/][ \t]*([\d]+)[ \t]*[ \t]*$/;

        var interpretAsNorthEastOrXY = function (obj) {
            if (obj && typeof obj.first === 'number' && typeof obj.second === 'number') {
                if (obj.first <= 180 && obj.first >= -180 && obj.second <= 180 && obj.second >= -180) {
                    obj.north = obj.first;
                    delete obj.first;

                    obj.east = obj.second;
                    delete obj.second;
                } else {
                    obj.x = obj.first;
                    delete obj.first;

                    obj.y = obj.second;
                    delete obj.second;
                }
            }
            return obj;
        };

        if (typeof input === 'string') {
            if (decimalPairComma.test(input)) {
                reResult = decimalPairComma.exec(input);
                parsedInput.first = parseFloat(reResult[1]);
                parsedInput.second = parseFloat(reResult[2]);
                if (!!reResult[3]) {
                  parsedInput.projectionHint = parseInt(reResult[3]);
                }
                interpretAsNorthEastOrXY(parsedInput);

            } else if (decimalPairDot.test(input)) {
                reResult = decimalPairDot.exec(input);
                parsedInput.first = parseFloat(reResult[1]);
                parsedInput.second = parseFloat(reResult[2]);
                if (!!reResult[3]) {
                  parsedInput.projectionHint = parseInt(reResult[3]);
                }
                interpretAsNorthEastOrXY(parsedInput);

            } else if (decimalCoordinatesNE.test(input)) {
                reResult = decimalCoordinatesNE.exec(input);
                parsedInput.north = {};
                parsedInput.east = {};
                parsedInput.north.deg = parseFloat(reResult[1]);
                parsedInput.east.deg = parseFloat(reResult[2]);
            } else if (degMinNE.test(input)) {
                reResult = degMinNE.exec(input);
                parsedInput.north = {};
                parsedInput.east = {};
                parsedInput.north.deg = parseFloat(reResult[1]);
                parsedInput.north.min = parseFloat(reResult[2]);
                parsedInput.east.deg = parseFloat(reResult[3]);
                parsedInput.east.min = parseFloat(reResult[4]);
            } else if (degMinEN.test(input)) {
                reResult = degMinEN.exec(input);
                parsedInput.north = {};
                parsedInput.east = {};
                parsedInput.east.deg = parseFloat(reResult[1]);
                parsedInput.east.min = parseFloat(reResult[2]);
                parsedInput.north.deg = parseFloat(reResult[3]);
                parsedInput.north.min = parseFloat(reResult[4]);
            } else if (degMinSecNE.test(input)) {
                reResult = degMinSecNE.exec(input);
                parsedInput.north = {};
                parsedInput.east = {};
                parsedInput.north.deg = parseFloat(reResult[1]);
                parsedInput.north.min = parseFloat(reResult[2]);
                parsedInput.north.sec = parseFloat(reResult[3]);
                parsedInput.east.deg = parseFloat(reResult[4]);
                parsedInput.east.min = parseFloat(reResult[5]);
                parsedInput.east.sec = parseFloat(reResult[6]);
            } else if (degMinSecEN.test(input)) {
                reResult = degMinSecEN.exec(input);
                parsedInput.north = {};
                parsedInput.east = {};
                parsedInput.east.deg = parseFloat(reResult[1]);
                parsedInput.east.min = parseFloat(reResult[2]);
                parsedInput.east.sec = parseFloat(reResult[3]);
                parsedInput.north.deg = parseFloat(reResult[4]);
                parsedInput.north.min = parseFloat(reResult[5]);
                parsedInput.north.sec = parseFloat(reResult[6]);
            } else if (degMinSecEN2.test(input)) {
                reResult = degMinSecEN2.exec(input);
                parsedInput.north = {};
                parsedInput.east = {};
                parsedInput.east.deg = parseFloat(reResult[1]);
                parsedInput.east.min = parseFloat(reResult[2]);
                parsedInput.east.sec = parseFloat(reResult[3]);
                parsedInput.north.deg = parseFloat(reResult[4]);
                parsedInput.north.min = parseFloat(reResult[5]);
                parsedInput.north.sec = parseFloat(reResult[6]);
            } else  if (gbrnr.test(input)) {
                reResult = gbrnr.exec(input);
                parsedInput.municipality = reResult[1].trim();
                parsedInput.gnr = reResult[2];
                parsedInput.bnr = reResult[3];
                parsedInput.numbers = [parsedInput.gnr, parsedInput.bnr];
            } else  if (gbrnr2.test(input)) {
                reResult = gbrnr2.exec(input);
                parsedInput.municipality = reResult[1].trim();
                parsedInput.gnr = reResult[2];
                parsedInput.bnr = reResult[3];
                parsedInput.fnr = reResult[4];
                parsedInput.numbers = [parsedInput.gnr, parsedInput.bnr, parsedInput.fnr];
            } else  if (gbrnr3.test(input)) {
                reResult = gbrnr3.exec(input);
                parsedInput.municipality = reResult[1].trim();
                parsedInput.gnr = reResult[2];
                parsedInput.bnr = reResult[3];
                parsedInput.fnr = reResult[4];
                parsedInput.snr = reResult[5];
                parsedInput.numbers = [parsedInput.gnr, parsedInput.bnr, parsedInput.fnr]; // snr confuses search engine not to output coordinates
            } else  if (gbrnr4.test(input)) {
              reResult = gbrnr4.exec(input);
              parsedInput.gnr = reResult[1];
              parsedInput.bnr = reResult[2];
              parsedInput.municipality = reResult[3].trim();
              parsedInput.numbers = [parsedInput.gnr, parsedInput.bnr];
            } else  if (gbrnr5.test(input)) {
              reResult = gbrnr5.exec(input);
              parsedInput.gnr = reResult[1];
              parsedInput.bnr = reResult[2];
              parsedInput.municipality = '';
              parsedInput.numbers = [parsedInput.gnr, parsedInput.bnr];
            } else {
                parsedInput.phrase = input;
            }
            var degMinSec2Deg = function (dms) {
                if (typeof dms.sec === 'number') {
                    dms.min += dms.sec / 60;
                    delete dms.sec;
                }
                if (typeof dms.min === 'number') {
                    dms.deg += dms.min / 60;
                    delete dms.min;
                }
            };
            if (parsedInput.north) {
                degMinSec2Deg(parsedInput.north);
                if (typeof parsedInput.north.deg === 'number') {
                    parsedInput.north = parsedInput.north.deg;
                }
            }
            if (parsedInput.east) {
                degMinSec2Deg(parsedInput.east);
                if (typeof parsedInput.east.deg === 'number') {
                    parsedInput.east = parsedInput.east.deg;
                }
            }
            return parsedInput;
        }
        return null;
};   

NK.controls.Search.prototype.onClick = function (event) {
        
        /*
            Start bugfix: 43616-162
        */
        var targ, e = event;
        var that = event.data;
        if (e) {
            if (e.target) {
                targ = e.target;
            } else if (e.srcElement) {
                targ = e.srcElement;
            }
            if (targ.nodeType == 3) targ = targ.parentNode; // Safari quirk
        }
        if (targ.nodeName.toLowerCase() === 'select' || 
            targ.nodeName.toLowerCase() === 'option') {
            e.stopPropagation ? e.stopPropagation() : e.cancelBubble = true;
            return false;
        }
        /*
            End bugfix: 43616-162
        */

        if ((!!event.target && (event.target.id === this.submitBtnId || $(event.target).parents('#' + this.submitBtnId).length > 0)) || event.srcElement === this.submitBtnId) {
            that.doSearch();
            return false;
        }
}

NK.controls.Search.prototype.drawResponse =  function() {

        var places, 
            xmlPlaces,
            listAreas = [],
            listAddress = [],
            addresses = [],
            listObjects = [],
            areasCount = 0,
            areasElement,
            areasListElement,
            addressesCount = 0, xtraCounter = 0,
            addressesElement,
            addressesListElement,
            objectsCount = 0,
            objectsElement,
            objectsListElement,
            results, 
            resultDiv,
            resultsList = $('#searchResults'),
            noResultsNotice,
            totalResultsCount,
            totalResultsReported = false,
            resultsPerPage,
            page,
            markers = [],
            i, 
            j,
            that = this,
            xml  = this.searchData.ssr,
            json = this.searchData.register;
        
        if (json !== null && json.length === 0) {
            json = this.searchData.address;
        } else if(json === null) {
            json = this.searchData.address;
        }

        xmlPlaces  = $(xml).find("sokRes > stedsnavn");

        // Remove loading notice
        var loadingNotice = $('#searchLoadingNotice');
        if (loadingNotice.length !== 0) loadingNotice.remove();

        // Init resultsList if it doesn't exist
        if ( resultsList.length === 0 ) {
            resultsList = $( '<div/>', { 'id': 'searchResults'});
            $('.searchDiv').after(resultsList);
        }
        resultsList.html(this.closeButtonHtml);

        // Re-attach close-button event handler
        resultsList.find('a.close').off( "click");
        resultsList.find('a.close').on( "click", function(e){
           resultsList.remove();
           return false;
        });

        if (xmlPlaces.length === 0 && json === null) {
            
            noResultsNotice = $('#noResultsNotice');
            if (noResultsNotice.length === 0) {
                noResultsNotice = $('<div/>', {'id':'noResultsNotice', html:'No records found'});
            }
            resultsList.append(noResultsNotice);

        } else {

            areasElement = $('<div class="result-category" />').addClass("areas");
            areasElement.append($('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMid meet" width="118.523px" height="99.009px" viewBox="0 0 118.523 99.009" class="icon area-search"><path d="M86.001,91.452h-9.809c-1.933,0-3.5-1.566-3.5-3.5c0-1.933,1.567-3.5,3.5-3.5h9.809c1.933,0,3.5,1.567,3.5,3.5C89.501,89.885,87.934,91.452,86.001,91.452 M56.578,91.452H46.77c-1.933,0-3.5-1.566-3.5-3.5c0-1.933,1.567-3.5,3.5-3.5h9.808c1.933,0,3.5,1.567,3.5,3.5C60.078,89.885,58.511,91.452,56.578,91.452 M27.155,91.452h-9.788c-1.933,0-3.51-1.566-3.51-3.5c0-1.933,1.557-3.5,3.49-3.5h9.808c1.933,0,3.5,1.567,3.5,3.5C30.655,89.885,29.088,91.452,27.155,91.452 M3.661,79.732c-1.695,0-3.185-1.235-3.454-2.962C0.069,75.885,0,74.98,0,74.083v-7.649c0-1.934,1.567-3.5,3.5-3.5c1.933,0,3.5,1.566,3.5,3.5v7.652c0,0.539,0.041,1.079,0.124,1.607c0.297,1.91-1.011,3.7-2.921,3.997C4.021,79.718,3.84,79.732,3.661,79.732 M107.5,57.914c-1.934,0-3.5-1.566-3.5-3.5v-9.808c0-1.933,1.566-3.5,3.5-3.5c1.933,0,3.5,1.567,3.5,3.5v9.808C111,56.347,109.433,57.914,107.5,57.914 M3.5,50.318c-1.933,0-3.5-1.567-3.5-3.5V37.01c0-1.933,1.567-3.5,3.5-3.5c1.933,0,3.5,1.567,3.5,3.5v9.808C7,48.751,5.433,50.318,3.5,50.318 M107.5,28.491c-1.934,0-3.5-1.567-3.5-3.5v-7.624c0-0.546-0.043-1.095-0.127-1.631c-0.3-1.91,1.005-3.701,2.914-4.001c1.908-0.298,3.701,1.004,4.001,2.914c0.141,0.895,0.212,1.809,0.212,2.718v7.624C111,26.924,109.433,28.491,107.5,28.491 M3.5,20.881c-1.933,0-3.5-1.553-3.5-3.486v-0.028c0-4.123,1.471-8.12,4.141-11.255C5.395,4.64,7.603,4.464,9.075,5.717c1.472,1.253,1.648,3.462,0.395,4.934C7.877,12.521,7,14.906,7,17.367C7,19.3,5.433,20.881,3.5,20.881 M93.625,7h-9.809c-1.933,0-3.5-1.567-3.5-3.5s1.567-3.5,3.5-3.5h9.809c1.933,0,3.5,1.567,3.5,3.5S95.558,7,93.625,7 M64.202,7h-9.809c-1.933,0-3.5-1.567-3.5-3.5s1.567-3.5,3.5-3.5h9.809c1.933,0,3.5,1.567,3.5,3.5S66.135,7,64.202,7 M34.779,7h-9.808c-1.933,0-3.5-1.567-3.5-3.5s1.567-3.5,3.5-3.5h9.808c1.933,0,3.5,1.567,3.5,3.5S36.712,7,34.779,7"/><path d="M117.406,86.157l-0.494-0.493h0.001L97.191,65.94c2.74-4.721,4.332-10.193,4.37-16.043c0.114-17.907-14.308-32.514-32.213-32.626c-0.072-0.001-0.143-0.001-0.215-0.001C51.33,17.271,36.835,31.651,36.72,49.483C36.607,67.388,51.029,81.995,68.934,82.11c0.072,0,0.14,0,0.212,0c5.951,0,11.528-1.612,16.326-4.416l19.705,19.708l0.002-0.002l0.493,0.492c1.489,1.49,3.904,1.489,5.396,0l6.339-6.338C118.896,90.065,118.896,87.648,117.406,86.157 M68.985,73.841c-13.316-0.086-24.081-10.989-23.997-24.307c0.086-13.231,10.918-23.997,24.146-23.997h0.162c6.45,0.041,12.5,2.591,17.031,7.182c4.532,4.591,7.006,10.672,6.964,17.125c-0.04,6.423-2.572,12.454-7.13,16.98c-4.555,4.526-10.599,7.017-17.017,7.017H68.985z"/></svg>'));
            areasElement.append($('<h2 class="h">Areas</h2>'));
            areasListElement = $('<ul/>');
            areasElement.append(areasListElement);

            addressesElement = $('<div class="result-category" />').addClass("addresses");
            addressesElement.append($('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="105" height="95" preserveAspectRatio="xMinYMid meet" viewBox="0 0 105 95" class="icon address"><path d="M60.145,61.984l-26.67-49.292L13.059,38.258v43.59l45.615,13.243L97.85,70.077V47.27L60.145,61.984z M34.395,23.911c2.97,0,5.378,3.541,5.378,7.909c0,4.368-2.408,7.909-5.378,7.909 c-2.971,0-5.378-3.541-5.378-7.909C29.017,27.452,31.424,23.911,34.395,23.911 M44.695,85.742l-20.6-5.886V47.454l20.6,3.495V85.742z" /><polygon points="0,41.936 32.555,0 78.538,0 104.372,38.89 62.492,54.64 34.823,4.844 2.143,44.661" /></svg>'));
            addressesElement.append($('<h2 class="h">Addresses</h2><ul>'));
            addressesListElement = $('<ul/>');
            addressesElement.append(addressesListElement);

            objectsElement = $('<div class="result-category" />').addClass("objects");         
            objectsElement.append($('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMid meet" width="98.55px" height="98.501px" viewBox="0 0 98.55 98.501" class="icon object"><path d="M21.851,65.556L0,98.502l32.863-22.014c-2.028-1.658-4.025-3.46-5.961-5.395C25.108,69.299,23.419,67.444,21.851,65.556 M87.38,11.169c-9.514-9.514-20.678-13.776-24.935-9.52c-1.302,1.303-1.804,3.253-1.604,5.603c-0.088,1.924-0.327,3.692-0.699,5.314L43.728,28.981c-5.035,1.432-9.881,1.523-12.484,1.432c-5.5-1.72-10.145-1.45-12.834,1.239c-5.964,5.963-0.066,21.527,13.17,34.763c13.236,13.236,28.799,19.133,34.762,13.17c2.271-2.271,2.817-5.936,1.898-10.332l0.053,0.052c0,0-0.941-7.566,1.394-15.295l15.463-15.463c1.872-0.469,3.944-0.76,6.243-0.831c2.308,0.177,4.224-0.328,5.506-1.612C101.156,31.848,96.896,20.685,87.38,11.169"/></svg>'));
            objectsElement.append($('<h2 class="h">Objects</h2><ul>'));
            objectsListElement = $('<ul/>');
            objectsElement.append(objectsListElement);

            $.each(json, function(){

                // Skip JSON objects without latlon properties
                if (!this.hasOwnProperty('LATITUDE') || !this.hasOwnProperty('LONGITUDE')) {

                    /* Rare case hotfix */
                    if (xmlPlaces.length === 0 && json.length === 1) {
                        noResultsNotice = $('#noResultsNotice');
                        if (noResultsNotice.length === 0) {
                            noResultsNotice = $('<div/>', {'id':'noResultsNotice', html:'No records found'});
                        }
                        resultsList.append(noResultsNotice);
                    }

                    return false;
                }

                var place, placeElement;
                var coords = [parseFloat(this['LONGITUDE']), parseFloat(this['LATITUDE'])];
                    coords = ol.proj.transform(coords, "EPSG:32632", "EPSG:4326");

                place = {
                    name: this['NAVN'].charAt(0) + this['NAVN'].slice(1).toLowerCase(),
                    ssrid: this['ID'],
                    type: this['OBJEKTTYPE'],
                    municipality: this['KOMMUNENAVN'].charAt(0) + this['KOMMUNENAVN'].slice(1).toLowerCase(),
                    county: this['FYLKESNAVN'].charAt(0) + this['FYLKESNAVN'].slice(1).toLowerCase(),
                    north: coords[1],
                    east: coords[0]
                };

                markers.push(place);

                placeElement = $('<li class="search-place">');
                placeElement.attr("data-east",  place.east);
                placeElement.attr("data-north", place.north);
                placeElement.attr("data-zoom",  12);

                if (typeof this['HUSNUMMER'] !== 'undefined' && this['HUSNUMMER'].length){
                    
                    var select = document.createElement('select');
                    var option = document.createElement('option');
                        option.value = '';

                    if (document.all) {
                        option.innerText = 'house number';
                    } else {
                        option.textContent = 'house number';
                    }

                    select.appendChild(option);

                    for (var i = 0; i < this['HUSNUMMER'].length; i++) {

                        option = document.createElement('option');

                        if (document.all) {
                            option.innerText = this['HUSNUMMER'][i];
                        } else {
                            option.textContent = this['HUSNUMMER'][i];
                        }

                        select.appendChild(option);
                    }

                    placeElement.append(select);
                }

                placeElement.append($('<span class="street-address"><span class="street-name">' + place.name + '</span></span>, <span class="municipality-name">' + place.municipality + '</span>'));
                addressesListElement.append(placeElement);

                addresses.push({'name': place.name, 'municipality': place.municipality, 'element': placeElement});
                addressesCount += 1;

            });

            xmlPlaces.each(function(){

                var place,
                    placeElement,
                    zoomLevel = 8;

                place = {
                    name: $(this).find("stedsnavn").text(),
                    ssrid: $(this).find("ssrId").text(),
                    type: $(this).find("navnetype").text(),
                    municipality: $(this).find("kommunenavn").text(),
                    county: $(this).find("fylkesnavn").text(),
                    north: parseFloat($(this).find("nord").text()),
                    east: parseFloat($(this).find("aust").text())
                };

                // Skip places handled by registerSearch
                if (place.type !== 'Adressenavn (veg/gate)'){
                    markers.push(place);
                }

                var i18nPlace = function(type) {
                  var no2en = {
                    'Nasjon':'Country',
                    'Fylke':'County',
                    'Kommune':'Municipality',
                    'By':'City',
                    'Adm. bydel':'Adm. district',
                    'Bydel':'District',
                    'Tettsted':'Village',
                    'Tettbebyggelse':'Settlement',
                    'Grend':'Hamlet',
                    'Fjellområde':'Mountain area',
                    'Bygdelag (bygd)':'Community',
                    'Tettsteddel':'Rural district',
                    'Adressenavn':'Address',
                    'Flyplass':'Airport',
                    'Fengsel':'Prison',
                    'Annen kulturdetalj':'Cultural highlight',
                    'Stasjon':'Station',
                    'Kirke':'Church',
                    'Bru':'Bridge',
                    'Skole':'School',
                    'Bruk (gardsbruk)':'Farm',
                    'Øy': 'Island',
                    'Universitet/høgskole': "University/college",
                    'Industriområde': 'Industrial area'
                  }
                  if (!!no2en[type]) {
                    return no2en[type];
                  }
                  return type;
                }
                
                var getPlaceElement = function (placeData, zoomLevel, contextFunction) {
                    var element = $('<li class="search-place">');
                    element.attr("data-east",  placeData.east);
                    element.attr("data-north", placeData.north);
                    element.attr("data-zoom",  zoomLevel);
                    element.html(placeData.name + ', ' + i18nPlace(placeData.type) + ' ');
                    if (!!contextFunction) {
                        element.append(contextFunction(placeData));
                    }
                    return element;
                };

                var countyFn = function (d) {
                    var element = $('<span class="county-name" />');
                    element.text(d.county);
                    return element;
                };
                var municipalityFn = function (d) {
                    var element = $('<span class="municipality-name" />');
                    element.text(d.municipality);
                    return element;
                };

                switch(place.type) {
                    case 'Nasjon':
                        placeElement = getPlaceElement(place, 1);
                        areasListElement.append(placeElement);
                        areasCount += 1;
                        break;
                    case 'Fylke':
                        placeElement = getPlaceElement(place, 8);
                        areasListElement.append(placeElement);
                        areasCount += 1;
                        break;
                    case 'Kommune':
                        placeElement = getPlaceElement(place, 8, countyFn);
                        areasListElement.append(placeElement);
                        areasCount += 1;
                        break;
                    case 'By':
                    case 'Adm. bydel':
                    case 'Bydel':
                    case 'Tettsted':
                    case 'Tettbebyggelse':
                    case 'Grend':
                    case 'Fjellområde':
                    case 'Bygdelag (bygd)':
                    case 'Tettsteddel':
                        placeElement = getPlaceElement(place, 8, municipalityFn);
                        areasListElement.append(placeElement);
                        areasCount += 1;
                        break;
                    case 'Adressenavn (veg/gate)':
                        /*
                        placeElement = $('<li class="search-place">');
                        placeElement.attr("data-east",  place.east);
                        placeElement.attr("data-north", place.north);
                        placeElement.attr("data-zoom",  12);
                        placeElement.append($('<span class="street-address"><span class="street-name">' + place.name + '</span></span>, <span class="municipality-name">' + place.municipality + '</span>'));
                        addressesListElement.append(placeElement);
                        addresses.push({'name': place.name, 'municipality': place.municipality, 'element': placeElement});
                        addressesCount += 1;
                        */
                        xtraCounter += 1;
                        break;
                    case 'Flyplass':
                    case 'Fengsel':
                    case 'Annen kulturdetalj':
                    case 'Stasjon':
                    case 'Kirke':
                    case 'Bru':
                    case 'Skole':
                    case 'Bruk (gardsbruk)':
                        placeElement = getPlaceElement(place, 16, municipalityFn);
                        objectsListElement.append(placeElement);
                        objectsCount += 1;
                        break;
                    default:
                        placeElement = getPlaceElement(place, 8, municipalityFn);
                        objectsListElement.append(placeElement);
                        objectsCount += 1;
                } // switch
            });

            totalResultsCount = $(xml).find('sokRes > totaltAntallTreff');
            totalResultsReported = totalResultsCount.length > 0;

            if (totalResultsReported) {
                if (typeof totalResultsCount[0].textContent === 'string') {
                    totalResultsCount = parseInt(totalResultsCount[0].textContent);
                } else if (typeof totalResultsCount[0].text === 'string') {
                    totalResultsCount = parseInt(totalResultsCount[0].text);
                }
            }

            totalResultsCount -= xtraCounter;
            totalResultsCount += addressesCount;
            if(totalResultsCount > 0) totalResultsReported = true;

            results = '';

            if (totalResultsReported) {
                resultsPerPage = parseInt($('#searchResultsPerPageInput').val());
                page = parseInt($('#searchResultsPageNumberInput').val());

                results += '<div class="result-paging">'; 
                results += 'Total search results: ' + totalResultsCount;
                if ((page * resultsPerPage + resultsPerPage) < totalResultsCount) {
                    results += '<button id="next-results-page-button">More results</button>';
                }
                results += '</div>';
            }


            this.addMarkers(markers);                      
        } // if

        resultsList.append($(results));

        if (areasCount > 0) {
            resultsList.append(areasElement);
        }
        if (addressesCount > 0) {
            resultsList.append(addressesElement);
        }
        if (objectsCount > 0) {
            resultsList.append(objectsElement);
        }

        resultsList.slideDown({'duration': 250}, function(){});

        $('#next-results-page-button').on('click', function (evt) {
            evt.stopPropagation ? evt.stopPropagation() : evt.cancelBubble = true;
            var currentPageNumber = $('#searchResultsPageNumberInput').val();
            $('#searchResultsPageNumberInput').val(parseInt(currentPageNumber) + 1);
            that.doSearch();
        });
        
        /*
            Handler for housenumber select menu
        */
        resultsList.on(
            'change', 
            '.result-category.addresses select', 
            function (evt) { 

                var $this, place, streetElement, municipalityElement, queryString;
                $this = $(this);
                place = $this.closest('.search-place');
                streetElement = place.find('.street-address')[0];
                municipalityElement = place.find('.municipality-name')[0];
                queryString = '';
                function getText (element) {
                    if (element) {
                        if (typeof element.textContent == 'string') {
                            return element.textContent;
                        } else if (typeof element.innerText === 'string') {
                            return element.innerText;
                        } else {
                            return '';
                        }
                    } else {
                        return '';
                    }
                } 
                if (streetElement) {
                    queryString += getText(streetElement)  + ' ' + $this.val().toString();
                    if (municipalityElement) {
                        queryString += ', ' + getText(municipalityElement); 
                    }
                }
                $.support.cors = true;
                
                $.ajax({
                    'url': that.addressSearchUrl,
                    'success': function (response) { 
                        var parsedResponse = $.parseJSON(response);
                        var place;

                        if (parsedResponse && parsedResponse.length > 0) {
                            var r = parsedResponse[0];
                            var point = [parseFloat(r['LONGITUDE']), parseFloat(r['LATITUDE'])]
                            point = ol.proj.transform(point,"EPSG:32632","EPSG:4326");
                            place = {
                                name: r['NAVN'],
                                type: r['OBJEKTTYPE'],
                                municipality: r['KOMMUNENAVN'],
                                county: r['FYLKESNAVN'],
                                north: point[1],
                                east: point[0]
                            };
                            that.addMarkers([place]);
                            point = ol.proj.transform(point,"EPSG:4326",map.getView().getProjection());
                            var zoom = 15;
                            map.getView().setCenter(point)
                            map.getView().setZoom( zoom);
                        }
                        $('#searchResults').remove();
                    },
                    'data': encodeURIComponent(queryString)
                });

            }
        );
        
}; // drawResponse

NK.controls.Search.prototype.getMarkerLayer = function() {
  if (this.markerLayer) {
    return this.markerLayer;
  }
  var cand = NK.util.getLayersBy('title','searchResults');
  return (cand.length > 0) ? cand[0] : null;
};

NK.controls.Search.prototype.addMarkers = function (places) {
        var layers, 
            marker,
            size, 
            offset,
            icon,
            coor_from,
            coor_to,
            i, 
            j,
            point,
	    mrk,
	    feature,
	    features = [],
	    styles,
	    that = this;

	coor_from = "EPSG:4326";
	coor_to   = map.getView().getProjection();

        this.markerStyle = this.markerStyle || new ol.style.Style({
             image: new ol.style.Icon({
               anchor: [11,11],
               anchorXUnits: 'pixels',
               anchorYUnits: 'pixels',
               src: '/theme/norgeskart/img/point-marker.png' 
             })
        });

        this.markerLayer = this.getMarkerLayer();

        if (!this.markerLayer) {


           this.markerLayer = new ol.layer.Vector({
             title: 'searchResults',
             isHelper: true,
             source: new ol.source.Vector()
           });
           map.addLayer(this.markerLayer);
        }
        
        this.markerLayer.getSource().clear();
        this.markerLayer.setVisible(true);
	
        for(i = 0, j = places.length; i < j; i += 1) {
            point = [places[i].east, places[i].north];
            point = ol.proj.transform(point, coor_from, coor_to);
            feature = new ol.Feature($.extend(places[i], {
              geometry: new ol.geom.Point(point)
            }));
            feature.setStyle(this.markerStyle);
            features.push(feature);
        }
        this.markerLayer.getSource().addFeatures(features);

        /*
        var selectControl;
        var onPopupClose = null;

        function onPopupClose(evt) {
            selectControl.unselect(NK.selectedFeature);
            delete NK.selectedFeature;
        }
        function generatePopupMarkup (feature) {
            var markup = '<article>';
            var COORDINATE_DECIMAL_COUNT = 4;

            function preciseRound(num, decimals){
                return Math.round(num*Math.pow(10,decimals))/Math.pow(10,decimals);
            }
            if (feature.attributes.type) {
                markup += '<h1 class="h">' + feature.attributes.name + '</h1>';

                switch (feature.attributes.type) {
                    case 'Nasjon':
                    case 'Fylke':
                        markup += "<div>" + feature.attributes.type + "</div>" + 
                            "Posisjon: " + preciseRound(feature.attributes.north, COORDINATE_DECIMAL_COUNT).toFixed(COORDINATE_DECIMAL_COUNT) + "°N " + preciseRound(feature.attributes.east, COORDINATE_DECIMAL_COUNT).toFixed(COORDINATE_DECIMAL_COUNT) + "°Ø";
                        break;
                    case 'Kommune':
                        markup += "<div>" + feature.attributes.type + " i " + feature.attributes.county + "</div>" + 
                            "Posisjon: " + preciseRound(feature.attributes.north, COORDINATE_DECIMAL_COUNT).toFixed(COORDINATE_DECIMAL_COUNT) + "°N " + preciseRound(feature.attributes.east, COORDINATE_DECIMAL_COUNT).toFixed(COORDINATE_DECIMAL_COUNT) + "°Ø";
                        break;
                    case 'Adressenavn (veg/gate)':
                        break;
                    case 'By':
                    case 'Adm. bydel':
                    case 'Bydel':
                    case 'Tettsted':
                    case 'Grend':
                    case 'Flyplass':
                    case 'Fengsel':
                    case 'Annen kulturdetalj':
                    case 'Stasjon':
                    case 'Kirke':
                    case 'Bru':
                    case 'Skole':
                    case 'Bruk (gardsbruk)':
                    default:
                        if (feature.attributes.address) {
                            if (typeof feature.attributes.address === 'string') {
                                markup += "<div>" + feature.attributes.address + "</div>";
                            } else if (feature.attributes.address.length) {
                                markup += "<div>" + feature.attributes.address.join(', ') + "</div>";
                            }
                        }
                        markup += "<div>" + feature.attributes.type + " i " + feature.attributes.municipality + ", " + feature.attributes.county + "</div>" + 
                            "Posisjon: " + preciseRound(feature.attributes.north, COORDINATE_DECIMAL_COUNT).toFixed(COORDINATE_DECIMAL_COUNT) + "°N " + preciseRound(feature.attributes.east, COORDINATE_DECIMAL_COUNT).toFixed(COORDINATE_DECIMAL_COUNT) + "°Ø";
                        break;
                }
                if (feature.attributes.ssrid) {
                    markup += '<div><a href="http://faktaark.statkart.no/SSRFakta/faktaarkfraobjektid?enhet=' + feature.attributes.ssrid + '">Faktaark</a></div>';
                }
            } else {
                // feature is a coordinate or gbrnr search result 
                markup += '<h1 class="h">' + preciseRound(feature.attributes.north, COORDINATE_DECIMAL_COUNT).toFixed(COORDINATE_DECIMAL_COUNT) + '°N ' + preciseRound(feature.attributes.east, COORDINATE_DECIMAL_COUNT).toFixed(COORDINATE_DECIMAL_COUNT) + '°Ø</h1>';
            }
            markup += "</article>";
            return markup;
        };

        function onFeatureSelect (feature) {
	    that.displayPointMenu( feature.geometry.getBounds().getCenterLonLat() );	    
        }
        function onFeatureUnselect (feature) {
            this.map.removePopup(feature.popup);
            if (feature.popup === NK.selectedFeature) {
                NK.selectedFeature = null;
            }
            feature.popup.destroy();
            feature.popup = null;

        }

        selectControl = new OpenLayers.Control.SelectFeature(that.markerLayer, {
            select: onFeatureSelect, 
            unselect: onFeatureUnselect,
            //hover: true,
            autoActivate: true
        });
        var hoverControl = new OpenLayers.Control.SelectFeature(that.markerLayer, {
            hover: true,
            highlightOnly: true,
            renderIntent: "temporary",
            autoActivate: true
        });
        this.map.addControl(hoverControl);
        this.map.addControl(selectControl);
        */
};// addMarkers

NK.controls.Search.prototype.abortRequests = function(){
  $.each(this.searchRequests, function(key, req){
    if (req !== null) {
      req.abort();
    }
  });
},

goog.object.extend(options, {
  target: container
});
NK.functions.addControlToContext(new NK.controls.Search(options), context);


}(controlContext, container));

}(controlContext, container, collect));

(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "panel";
}

  container = document.createElement("li");
    container.id = "del-panel";


  container.className = className;
  collect.appendChild(container);


	(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "topnavpanel toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "topnavpanel";
}

  container = document.createElement("li");
    container.id = "print-panel";


  container.className = className;
  collect.appendChild(container);


	

(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	

NK.controls = NK.controls || {};
NK.controls.Print = function(options) {
  options = options || {};
  var wrapper, btn;
  var cName = 'print-button nkButton';
  
  this.title = "Print";

  wrapper = document.createElement('div');
  btn    = document.createElement('button');
  wrapper.appendChild(btn);

  btn.title = this.title;
  btn.className = btn.className === "" ? cName : btn.className + " " + cName;
  btn.innerHTML = '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" preserveAspectRatio="xMinYMid meet" class="icon print"><path d="M17.617,2H6.383v3.299h11.234V2z M21.026,6.487H2.974C2.437,6.487,2,6.934,2,7.483v7.327h2.934v-4.448h14.133v4.448H22V7.483C22,6.934,21.564,6.487,21.026,6.487z M19.885,8.929c-0.43,0-0.779-0.356-0.779-0.796s0.35-0.797,0.779-0.797s0.778,0.357,0.778,0.797S20.314,8.929,19.885,8.929z M16.787,20.828h-4.701c-1.703,0-0.883-4.129-0.883-4.129s-3.937,0.979-3.987-0.867v-3.79H6.069v5.339l0.336,0.344L10.586,22h7.347v-9.958h-1.146V20.828z" /></svg>';

  $(btn).click(this, this.exportMap);
  
  ol.control.Control.call(this, {
    element: wrapper,
    target: options.target
  });

}
ol.inherits(NK.controls.Print, ol.control.Control);

NK.controls.Print.prototype.exportMap = function(event) {
  var self = event.data; 
  map.once('postcompose', function(event) {
    var canvas = event.context.canvas;
    var win = window.open(canvas.toDataURL('image/png'), '_blank');
    win.print();
  });
  map.renderSync();
};

NK.functions.addControlToContext(new NK.controls.Print({target: container}), context);


}(controlContext, container));

}(controlContext, container, collect));

(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "topnavpanel toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "topnavpanel";
}

  container = document.createElement("li");
    container.id = "getURL-panel";


  container.className = className;
  collect.appendChild(container);


	

(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	

NK.controls = NK.controls || {};
NK.controls.GetURL = function(options) {
  options = options || {};
  var wrapper, btn;
  var cName = 'getURL-button nkButton';

  this.title = 'Share URL';
  
  wrapper = document.createElement('div');
  btn    = document.createElement('button');
  wrapper.appendChild(btn);

  $(btn).click(this, this.toggle);
  
  map.getView().on("change:center", this.changeHash);
  map.getView().on("change:resolution", this.changeHash);
  
  btn.title = this.title;
  btn.className = btn.className === "" ? cName : btn.className + " " + cName;
  btn.innerHTML = '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" class="icon share"><path d="M14.843,15.493c-0.497,0-0.967,0.118-1.385,0.329l-2.421-2.495c0.178-0.407,0.277-0.858,0.277-1.335c0-0.476-0.1-0.927-0.277-1.334l2.411-2.485c0.42,0.214,0.894,0.334,1.395,0.334C16.587,8.507,18,7.051,18,5.253C18,3.457,16.587,2,14.843,2s-3.157,1.457-3.157,3.253c0,0.436,0.083,0.851,0.233,1.23L9.453,9.025C9.058,8.842,8.619,8.739,8.157,8.739C6.414,8.739,5,10.196,5,11.992c0,1.797,1.414,3.254,3.157,3.254c0.462,0,0.9-0.104,1.296-0.286l2.471,2.546c-0.153,0.383-0.238,0.802-0.238,1.241c0,1.797,1.413,3.254,3.157,3.254S18,20.544,18,18.747S16.587,15.493,14.843,15.493z" /></svg>';
 
  this.cnt = document.createElement("div");
  this.cnt.className="cnt";
  this.widget = NK.util.createWidget(this.cnt, 1);

  wrapper.appendChild( this.widget );
  this.div = options.target;

  ol.control.Control.call(this, {
    element: wrapper,
    target: options.target
  });

}
ol.inherits(NK.controls.GetURL, ol.control.Control);

NK.controls.GetURL.prototype.changeHash = function() {        
    	var btn = this.div;
    	if (! $(btn).hasClass('active') ) return;
    	setTimeout( function() { $(btn).addClass('active'); }, 500 );
};

NK.controls.GetURL.prototype.toggle = function (event) {
        var self = event.data;
        $(self.div).hasClass('active') ? self.hide() : self.show();
};

NK.controls.GetURL.prototype.show = function () {
    	this.cnt.innerHTML = this.getContent();
        $(this.div).addClass('active');
};
NK.controls.GetURL.prototype.hide = function () {
        $(this.div).removeClass('active');
};

NK.controls.GetURL.prototype.getContent = function (center) {   
        var url     = window.location.href;
        url = url.replace("[","%5B").replace("]","%5D");
        var safeURL = encodeURIComponent(window.location.href);
        safeURL = safeURL.replace("%5B","%255B").replace("%5D","%255D");

        var html = '<h1 class="h">Share map</h1>';
        html += '<div class="page-url">' + url + '</div>';
        html += '<span>Share by:</span>';
        html += '<a class="share-link email" title="e-mail" href="mailto:?subject=norgeskart.no&body=' + safeURL + '"><span>e-mail</span><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" width="71.878px" height="54.479px" viewBox="0 0 71.878 54.479" preserveAspectRatio="xMidYMid meet"  class="icon email"><path d="M69.28,17.595c-1.732-3.751-4.121-6.928-7.164-9.526c-3.044-2.597-6.64-4.592-10.786-5.983C47.185,0.695,42.696,0,37.867,0c-5.091,0-9.919,0.879-14.485,2.637c-4.567,1.76-8.582,4.266-12.046,7.518c-3.464,3.255-6.22,7.192-8.266,11.81C1.023,26.584,0,31.753,0,37.474c0,5.617,0.891,10.563,2.676,14.841c0.298,0.715,0.96,2.078,0.96,2.078h10.545c-1.454-1.827-2.635-3.89-3.514-6.211c-1.234-3.254-1.85-6.928-1.85-11.021c0-4.146,0.734-7.992,2.204-11.535c1.469-3.543,3.504-6.598,6.102-9.171c2.597-2.571,5.654-4.592,9.172-6.062c3.515-1.469,7.321-2.204,11.415-2.204c3.569,0,6.901,0.421,9.999,1.259c3.096,0.84,5.787,2.165,8.07,3.976c2.282,1.81,4.079,4.107,5.392,6.888c1.312,2.782,1.969,6.141,1.969,10.078c0,2.729-0.328,5.091-0.983,7.085c-0.658,1.996-1.51,3.648-2.559,4.961c-1.052,1.312-2.232,2.283-3.543,2.913c-1.313,0.629-2.651,0.945-4.016,0.945c-1.365,0-2.244-0.553-2.638-1.654c-0.394-1.103-0.381-2.885,0.041-5.354l3.778-21.335h-5.512l-2.44,2.52c-1.051-0.892-2.204-1.614-3.464-2.165c-1.261-0.552-2.81-0.826-4.646-0.826c-2.676,0-5.209,0.721-7.597,2.164c-2.389,1.444-4.488,3.344-6.299,5.707c-1.81,2.363-3.241,5.079-4.29,8.148c-1.05,3.071-1.575,6.233-1.575,9.488c0,1.731,0.249,3.307,0.748,4.723c0.498,1.416,1.168,2.625,2.008,3.621c0.839,0.998,1.836,1.771,2.991,2.323c1.155,0.551,2.362,0.826,3.621,0.826c1.575,0,3.019-0.235,4.33-0.708c1.312-0.473,2.52-1.115,3.623-1.93c1.101-0.812,2.111-1.744,3.031-2.795c0.917-1.049,1.771-2.126,2.559-3.228h0.314c-0.158,1.628-0.053,2.99,0.315,4.095c0.367,1.102,0.932,1.994,1.691,2.676c0.762,0.683,1.707,1.169,2.835,1.457c1.129,0.289,2.349,0.433,3.66,0.433c3.15,0,6.103-0.63,8.857-1.89c2.756-1.26,5.17-2.965,7.244-5.117c2.071-2.152,3.699-4.696,4.88-7.637c1.181-2.939,1.771-6.087,1.771-9.447C71.878,25.612,71.013,21.349,69.28,17.595 M40.781,38.34c-0.579,1.051-1.234,2.048-1.968,2.99c-0.737,0.946-1.497,1.787-2.284,2.521c-0.788,0.736-1.601,1.326-2.44,1.771c-0.84,0.447-1.628,0.671-2.362,0.671c-1.732,0-2.953-0.553-3.661-1.654c-0.709-1.103-1.063-2.52-1.063-4.251c0-1.681,0.262-3.399,0.787-5.158c0.525-1.757,1.272-3.345,2.243-4.763c0.971-1.417,2.127-2.57,3.465-3.464c1.339-0.892,2.794-1.338,4.369-1.338c1.103,0,2.021,0.157,2.756,0.472c0.734,0.315,1.444,0.762,2.126,1.34L40.781,38.34z" /></svg></a>';
        html += '<a class="share-link twitter" title="Twitter" href="http://twitter.com/share?url=' + safeURL + '"><span>Twitter</span><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="72px" height="72px" viewBox="0 0 72 72" preserveAspectRatio="xMidYMid meet" class="icon twitter"><path d="M36,0C16.118,0,0,16.117,0,36s16.118,36,36,36s36-16.117,36-36S55.882,0,36,0 M32.07,45.868c1.087,1.087,2.404,1.63,3.958,1.63H47.2c1.551,0,2.882,0.557,3.991,1.664c1.106,1.106,1.662,2.435,1.662,3.984c0,1.549-0.556,2.879-1.662,3.985c-1.109,1.106-2.437,1.66-3.989,1.66h-11.17c-4.652,0-8.63-1.649-11.932-4.952c-3.303-3.303-4.952-7.28-4.952-11.934V19.369c0-1.596,0.549-2.935,1.649-4.022c1.099-1.084,2.444-1.629,4.029-1.629c1.54,0,2.863,0.554,3.962,1.663c1.101,1.105,1.652,2.433,1.652,3.984v5.647h16.742c1.558,0,2.891,0.552,4.004,1.662c1.111,1.105,1.667,2.433,1.667,3.983c0,1.549-0.556,2.879-1.662,3.986c-1.109,1.105-2.44,1.662-3.991,1.662H30.44v5.597C30.44,43.458,30.982,44.777,32.07,45.868"/></svg></a>';
//        html += '<iframe src="//www.facebook.com/plugins/like.php?href=' + encodeURIComponent(window.location.href) + '&amp;send=false&amp;layout=button_count&amp;width=45&amp;show_faces=false&amp;font=arial&amp;colorscheme=light&amp;action=like&amp;height=21" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:45px; height:21px;" allowTransparency="true"></iframe>';
        html += '<a class="share-link facebook" title="Facebook" href="http://www.facebook.com/sharer.php?u=' + safeURL + '"><span>Facebook</span><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="140px" height="140px" viewBox="0 0 140 140" preserveAspectRatio="xMidYMid meet" class="icon facebook"><path d="M70.148,0C31.407,0,0,31.407,0,70.149c0,36.744,28.258,66.87,64.225,69.881V86.93h-17.79V64.832h17.79V53.714c0-15.94,11.97-28.909,26.684-28.909h17.79v22.029h-17.79c-2.099,0-4.448,2.854-4.448,6.671v11.327h22.238V86.93H86.461v51.441c30.872-7.356,53.837-35.099,53.837-68.222C140.298,31.407,108.891,0,70.148,0"/></svg>' + '</a>';
	
	   return '<div class="getURLcontent">'+html+'</div>';
}; 

NK.functions.addControlToContext(new NK.controls.GetURL({target: container}), context);


}(controlContext, container));

}(controlContext, container, collect));

(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "topnavpanel toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "topnavpanel";
}

  container = document.createElement("li");
    container.id = "help-panel";


  container.className = className;
  collect.appendChild(container);


	

(function (context, container) {

	var options = {};
	if (container) {
		options.div = container;
	}
	

NK.controls = NK.controls || {};
NK.controls.Help = function(options) {
  options = options || {};
  var wrapper, btn;
  var cName = 'help-button nkButton';
  
  this.title = 'Help';

  wrapper = document.createElement('div');
  btn    = document.createElement('button');
  wrapper.appendChild(btn);

  $(btn).click(this, this.toggle);
  
  btn.title = this.title;
  btn.className = btn.className === "" ? cName : btn.className + " " + cName;
  btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 280.228821 280.228821" version="1.1"><g id="surface1"><path style="fill:none;stroke-width:9.6;stroke-linecap:butt;stroke-linejoin:round;stroke:rgb(100%,100%,100%);stroke-opacity:1;stroke-miterlimit:4;" d="M 275.429688 140.113281 C 275.429688 214.808594 214.808594 275.429688 140.113281 275.429688 C 65.421875 275.429688 4.800781 214.808594 4.800781 140.113281 C 4.800781 65.421875 65.421875 4.800781 140.113281 4.800781 C 214.808594 4.800781 275.429688 65.421875 275.429688 140.113281 Z M 275.429688 140.113281 "/><path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 113.675781 59.667969 C 113.675781 52.898438 116.25 47.125 121.398438 42.347656 C 126.542969 37.570312 132.710938 35.179688 139.894531 35.179688 C 147.1875 35.179688 153.40625 37.570312 158.554688 42.347656 C 163.699219 47.125 166.273438 52.898438 166.273438 59.667969 C 166.273438 66.339844 163.699219 72.113281 158.554688 76.988281 C 153.40625 81.769531 147.1875 84.15625 139.894531 84.15625 C 132.710938 84.15625 126.542969 81.769531 121.398438 76.988281 C 116.25 72.113281 113.675781 66.339844 113.675781 59.667969 Z M 164.023438 105.511719 L 164.023438 246.464844 L 116.25 246.464844 L 116.25 105.511719 L 164.023438 105.511719 "/></g></svg>';

  this.cnt = document.createElement("div");
  this.cnt.className="cnt";

  var mac = (navigator.platform && navigator.platform.indexOf('Mac') !== -1) || (navigator.userAgent && navigator.userAgent.indexOf('iPhone') !== -1);
  var ctrlKey = mac ? '⌘ ' : 'Ctrl + ';
  var html = '<div id="shortcuts" class="help-menu">';
  html += '<h1 class="h">' + 'Keyboard shortcuts' + '</h1>';
  html += '<div class="shortcuts-panel"><p>' + 'You can navigate using the following keyboard shortcuts' + ':</p>';
  html += '<p>' + 'Press TAB to change selected control. Press ENTER to activate the selected control.' + '</p>';

  html += '<table><thead><tr><th scope="col">' + 'Keyboard shortcut' + '</th><th scope="col">' + 'Function' + '</th></tr></thead><tbody>';
  html += '<tr><td>F11</td><td>'+'Full screen'+'</td></tr>';
  html += '<tr><td>' + ctrlKey + 'P</td><td>'+ 'Print'+'</td></tr>';
  html += '<tr><td>+ og -</td><td>'+ 'Zoom'+'</td></tr>';
  html += '<tr><td>'+ 'Arrow keys'+'</td><td>'+ 'Pan'+'</td></tr>';
  html += '<tr><td>Home, End, PageUp, PageDown</td><td>'+  'Fast panning'+'</td></tr>';
  html += '</tbody></table>';
  html += '</div>';

  html += '<h1 class="h">Ofte stilte sp\u00f8rsm\u00e5l om norgeskart.no</h1>';
  html += '<div id="faqBox" class="faq-panel">'
  html += '</div>';

  html += '</div>';
  this.cnt.innerHTML = html;

  this.widget = NK.util.createWidget(this.cnt, 1);

  options.target.appendChild( this.widget );
  this.div = options.target;

  ol.control.Control.call(this, {
    element: wrapper,
    target: options.target
  });
  $.ajax({
    url: 'http://skrivte57.statkart.no/miecar/js/faq.txt',
    success: function (response, status, request) {
      var faq = request.responseText.replace(/[\"\r\n]/g, '');
      $("#faqBox").html(faq);

      $(".faq-panel").accordion({
        collapsible: true,
        heightStyle: "content"
      });
      $(".help-menu").accordion({
        collapsible: true,
        heightStyle: "content",
        active: false
      });
    },
    type: 'GET'
  });
};
ol.inherits(NK.controls.Help, ol.control.Control);

NK.controls.Help.prototype.toggle = function (event) {
        var self = event.data;
        $(self.div).toggleClass('active');
};


NK.functions.addControlToContext(new NK.controls.Help({target: container}), context);


}(controlContext, container));

}(controlContext, container, collect));

}(controlContext, container, collect));

}(controlContext, container, collect));

(function (context, containerParam, collect) {
var parentContainer = document.body,
container;
  var className = "toolbar";

// set parentContainer if divControllerContainer is set
if (containerParam) {
parentContainer = containerParam;
  className = "panel";
}


  container = document.createElement("div");
    container.id = "<built-in function id>";



  container.className = className;
  parentContainer.appendChild(container);




}(controlContext, container, collect));

var omap = new ol.control.OverviewMap({
  projection: NK.projections['32633'],
  className: 'overview-container-panel'
})

map.addControl(omap);

ol.interaction.defaults().forEach(function(i){ 
  omap.ovmap_.addInteraction(i);
});


  if (!!NK.functions.setMapStateFromURL) {
    NK.functions.setMapStateFromURL();
  }

  if (!!NK.functions.updateHistory) {
    NK.view.on("change:center", NK.functions.updateHistory);
    NK.view.on("change:resolution", NK.functions.updateHistory);
    NK.view.on("change:rotation", NK.functions.updateHistory);
    map.getLayers().forEach(function(l) {
      l.on("change:visible", NK.functions.updateHistory);
      l.on("change:opacity", NK.functions.updateHistory);
    });
    NK.functions.updateHistory();
  }

  if (NK.functions.postMessage) {
    (function () {
      var vectorLayers,
          layer,
          feature,
          vectorLayerData = [],
          vectorFeatureData = [],
          i,
          j,
          k,
          l,
          message;

      vectorLayers = NK.util.getLayersBy('layerGroup','dekning').slice();

      for (i = 0, j = vectorLayers.length; i < j; i += 1) {
        layer = vectorLayers[i];
        vectorLayerData.push({shortid: layer.get('shortid'), name: layer.get('title'), visibility: layer.getVisible()});

        if (layer.getVisible() && layer.getSource().getFeatures().length) {

          var features = layer.getSource().getFeatures();
          for (k = 0, l = features.length; k < l; k += 1) {
            feature = features[k];
            vectorFeatureData.push({
              "feature": feature.getId(),
              "attributes": feature.values_ //feature.getAttributes()
            });
          }

        }
      }

      message = {
        "type": "mapInitialized",
        "vectorLayers": vectorLayerData
      };

      if (vectorFeatureData.length > 0) {
        message.visibleLayerFeatures = vectorFeatureData;
      }

      NK.functions.postMessage(message);
    }());

  }



};
// end init()


var addEvent = function(event, handler) {
  var listen = window.addEventListener || window.attachEvent;
  if (window.addEventListener) {
    listen(event, handler, false);
  } else {
    listen("on" + event, handler);
  }
};

var cb = function(response, status, request) {
  NK.gkToken = request.responseText.replace(/[\"\r\n]/g, '');
  NK.init();
};

var initializeToken = function () {
  $.ajax({
    url: NK.tokenService, 
    success: cb,
    type: 'GET'
  });
};
addEvent('load', initializeToken);

